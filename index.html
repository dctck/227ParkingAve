<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>227 Parking Ave</title>

    <!-- Custom Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poor+Story&display=swap" rel="stylesheet">

    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>


    <style>
        /* General Body and Font Styles */
        body {
            font-family: "Poor Story", system-ui;
            font-weight: 400;
            font-style: normal;
            background-color: #000;
            color: #fff;
            margin: 0;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            text-transform: uppercase;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #000;
            border-bottom: 2px solid #fff;
            padding: 15px 40px;
            display: none;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-sizing: border-box;
        }

        .navbar.show {
            display: flex;
        }

        .navbar-title {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .navbar-auth {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .screen {
            width: 100%;
            height: 100%;
            height: calc(100dvh - env(safe-area-inset-bottom));
            display: none; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            position: absolute;
            top: 0;
            left: 0;
        }

        .screen.active {
            display: flex;
        }

        
        #lobby-screen {
            flex-direction: row;
            justify-content: center;
            align-items: flex-start; 
            gap: 100px;
            position: relative;
            padding-top: 120px; /* Space for fixed navbar */
            padding-bottom: 50px; /* Bottom padding */
            min-height: 100vh; /* Ensure full height */
            overflow-y: auto; /* Allow vertical scrolling */
            box-sizing: border-box;
            padding-bottom: calc(50px + env(safe-area-inset-bottom)); 
        }

        .site-title {
            position: absolute;
            top: 20px; /* Reduced from 40px */
            left: 50%;
            transform: translateX(-50%);
            font-size: 4rem; /* Reduced from 10rem */
            font-weight: 700;
            letter-spacing: 2px; /* Reduced from 5px */
        }
        #lobby-screen .news-board {
            border: 2px solid #fff;
            padding: 20px 40px;
            background-color: #000;
            width: 600px;
            height: 480px; /* Fixed height */
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }
        .lobby-buttons {
            position: static; /* Changed from absolute */
            display: flex;
            flex-direction: row; /* Changed to row for mobile */
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        .news-content {
            overflow-y: auto; /* Make content scrollable */
            padding-right: 20px; /* For scrollbar spacing */
        }
         /* Simple scrollbar styling for webkit browsers */
        .news-content::-webkit-scrollbar, .unit-content::-webkit-scrollbar, .modal::-webkit-scrollbar, .store-items::-webkit-scrollbar { width: 8px; }
        .news-content::-webkit-scrollbar-track, .unit-content::-webkit-scrollbar-track, .modal::-webkit-scrollbar-track, .store-items::-webkit-scrollbar-track { background: #000; }
        .news-content::-webkit-scrollbar-thumb, .unit-content::-webkit-scrollbar-thumb, .modal::-webkit-scrollbar-thumb, .store-items::-webkit-scrollbar-thumb { background: #555; border: 2px solid #000; }

        #lobby-screen h2 { margin-top: 0; font-size: 1.5rem; }
        #lobby-screen p, #lobby-screen ul { line-height: 1.6; font-size: 1rem; }
        #lobby-screen ul { padding-left: 20px; list-style-type: none; }
        #lobby-screen li { margin-bottom: 10px; }
        #lobby-screen .lobby-footer { font-size: 1.2rem; }
        .lobby-buttons {
            position: absolute;
            top: 40px;
            right: 40px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .lobby-btn {
            border: 2px solid #fff; /* Ensure 2px border */
            background: #000;
            color: #fff;
            padding: 10px 20px;
            font-family: "Poor Story", system-ui;
            font-weight: 400;
            font-style: normal;
            text-transform: uppercase;
            cursor: pointer;
            min-width: 160px;
            text-align: center;
        }

        #clear-data-btn {
            background: #500;
            border: 2px solid #fff; /* Ensure 2px border */
        }


        /* Elevator Screen Styles */
        #elevator-screen { gap: 50px; flex-direction: column; }
        .elevator-top-indicator { border: 2px solid #fff; padding: 10px 40px; font-size: 2.5rem; }
        .elevator-main-panel { display: flex; gap: 30px; align-items: center; }
        .elevator-panel { display: grid; grid-template-columns: repeat(10, 1fr); gap: 15px; width: 100%; max-width: 800px; }
        .floor-button { border: 2px solid #fff; background: #000; color: #fff; font-size: 1.5rem; aspect-ratio: 1/1; cursor: pointer; }
        .floor-button.active { background: #fff; color: #000; }
        .floor-button:disabled { border-color: #555; color: #555; cursor: not-allowed; }
        .elevator-side-controls { display: flex; flex-direction: column; justify-content: space-between; align-items: center; height: 300px; }
        .side-button { border: 2px solid #fff; background: #000; color: #fff; width: 60px; height: 60px; font-size: 1.5rem; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .side-button:disabled { opacity: 0.5; }
        .side-button.home-disabled { background-color: #555; }


        /* Floor Screen Styles */
        #floor-screen {
            justify-content: initial;
            overflow: hidden;
            padding-top: 10vh; /* Pushes content down from the top */
        }
        .floor-hallway {
            display: flex;
            align-items: center;
            gap: 40px;
            padding: 0 50px;
            position: absolute;
            left: 0;
            transition: left 0.5s ease-out, opacity 0.3s ease-in-out;
        }
        .unit { border: 2px solid #fff; width: 500px; height: 500px; flex-shrink: 0; padding: 20px; box-sizing: border-box; position: relative; display: flex; flex-direction: column; }
        .unit.my-unit.green-outline { border-color: #0f0; box-shadow: 0 0 15px #0f0; }
        .unit.vacant { font-size: 3rem; }
        .unit-header { display: flex; justify-content: space-between; font-size: 1.2rem; flex-shrink: 0; }
        .unit-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center; /* Default to center for short content */
            align-items: center;
            gap: 20px;
            overflow-y: auto; /* Make content scrollable */
            padding: 20px 10px 50px 10px; /* Added more padding-bottom for edit button */
            box-sizing: border-box;
        }
        .unit-image-container {
            width: 200px;
            height: 200px;
            border: 2px solid #fff;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .unit-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .unit-text {
            font-size: 1.8rem;
            word-wrap: break-word;
            white-space: pre-wrap;
            text-align: center;
            width: 100%;
        }
        
        .unit .edit-button {
            display: block; /* Always show for own units */
            position: absolute;
            bottom: 20px;
            right: 20px;
            border: 2px solid #fff;
            background: #000;
            color: #fff;
            padding: 10px 20px;
            cursor: pointer;
            z-index: 20; /* Ensure it stays on top */
        }

        .unit.my-unit .unit-content {
            padding: 20px 10px 70px 10px; /* Increased bottom padding from 50px to 70px */
            margin-bottom: 0; 
        }

        .unit.my-unit:hover .edit-button {
            display: block; 
        }

        .elevator-section {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-shrink: 0;
            height: 500px;
        }

        .elevator-door {
            width: 200px;
            height: 500px;
            border: 2px solid #fff;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .elevator-door::before, .elevator-door::after { content: ''; position: absolute; width: 2px; height: 500px; background: #fff; }
        .elevator-call-panel { display: flex; flex-direction: column; gap: 15px; border: 2px solid #fff; padding: 15px; }
        .call-button { width: 50px; height: 50px; font-size: 1.5rem; border: 2px solid #fff; background: #000; color: #fff; cursor: pointer; }
        .call-button.home-active { background: #555; cursor: not-allowed; }
        .hallway-floor-display { border: 2px solid #fff; padding: 10px; margin-bottom: 15px; text-align: center; font-size: 1.5rem; }
        .view-upstairs-arrow {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-bottom: 20px solid #fff;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .travel-indicator { position: absolute; font-size: 10rem; opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none; }
        .travel-indicator.visible { opacity: 1; }

        .elevator-call-panel .call-button {
            position: relative;
        }

        .elevator-call-panel .call-button:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            border: 1px solid #555;
        }

        .elevator-call-panel .call-button:hover::before {
            content: '';
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #333;
            z-index: 1000;
        }

        /* Upstairs Viewer Styles */
        #upstairs-screen { position: relative; }
        .go-back-control { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .go-back-control .arrow { width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 20px solid #fff; }

        /* Store Screen Styles */
        #store-screen {
            flex-direction: column;
            justify-content: flex-start;
            padding-top: 100px;
        }
        .store-header {
            font-size: 2.5rem;
            margin-bottom: 40px;
        }
        .store-items {
            width: 90%;
            max-width: 800px;
            height: 60vh;
            overflow-y: auto;
            border: 2px solid #fff;
            padding: 20px;
        }
        .store-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #555;
        }
        .store-item:last-child {
            border-bottom: none;
        }
        .item-info h3 {
            margin: 0 0 5px 0;
            font-size: 1.5rem;
        }
        .item-info p {
            margin: 0;
            font-size: 1rem;
            color: #aaa;
        }
        .item-action {
            text-align: right;
        }
        .item-action .unlocks-text {
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #aaa;
        }
        .item-action .price-btn {
            border: 2px solid #fff;
            background: #fff;
            color: #000;
            padding: 10px 20px;
            font-family: 'Courier New', Courier, monospace;
            text-transform: uppercase;
            cursor: pointer;
        }
        .item-action .unlocked-label {
            border: 2px solid #0f0;
            color: #0f0;
            padding: 10px 20px;
        }
        .item-action .locked-label {
            border: 2px solid #555;
            color: #555;
            padding: 10px 20px;
        }

        .lobby-footer-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #555;
        }

        .lobby-footer {
            margin: 0;
            font-size: 1.2rem;
                align-items: center;

        }


        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); justify-content: flex-start; align-items: center; overflow-y: auto; }
        .modal-content { background-color: #000; padding: 30px; border: 2px solid #fff; width: 90%; max-width: 500px; text-align: center; margin-top: 5vh; margin-bottom: 5vh; }
        .modal-content h2 { font-size: 1.5rem; }
        #edit-textarea { width: 100%; height: 100px; background-color: #000; color: #fff; border: 1px solid #fff; padding: 10px; font-family: 'Courier New', Courier, monospace; font-size: 1.2rem; box-sizing: border-box; resize: none; text-transform: uppercase; margin-bottom: 5px; }
        
        #current-image-container { display: none; margin-bottom: 15px; margin-top: 25px; }
        #current-image-preview { width: 150px; height: 150px; border: 2px solid #fff; object-fit: cover; }
        #remove-image-btn { display: none; background-color: #500; color: #fff; border: 2px solid #fff; padding: 5px 10px; font-size: 0.8rem; cursor: pointer; margin-top: 10px; }

        #image-upload-label { display: block; padding: 10px; border: 2px solid #fff; cursor: pointer; margin-bottom: 10px; }
        #image-upload { display: none; }
        #image-preview-text { font-size: 0.9rem; color: #aaa; margin-bottom: 15px; height: 20px;}
        .image-options { display: none; justify-content: center; gap: 20px; margin-bottom: 20px; }
        #char-count { font-size: 0.9rem; color: #aaa; align-self: flex-end; margin-bottom: 25px; }
        .modal-actions { display: flex; justify-content: space-around; width: 100%; }
        .modal-actions button { font-family: 'Courier New', Courier, monospace; font-size: 1rem; padding: 10px 20px; margin: 15px 5px 0 5px; cursor: pointer; border: 2px solid #fff; background: #fff; color: #000; text-transform: uppercase; }
        #move-out-btn { background: #500; color: #fff;}

        /* Mobile Responsive Styles */
    

        .store-item.selected {
            background-color: #333;
            border: 2px solid #fff;
        }

        .store-purchase-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 20px;
            align-items: center;
        }

        .total-price {
            font-size: 1.5rem;
            padding: 10px 20px;
            border: 2px solid #fff;
            background: #000;
        }

        .purchase-all-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            border: 2px solid #fff;
            background: #fff;
            color: #000;
            cursor: pointer;
            font-family: "Poor Story", system-ui;
            text-transform: uppercase;
        }

        .side-button, .call-button {
            position: relative;
        }

        .side-button:hover::after, .call-button:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
        }

        .side-button:hover::before, .call-button:hover::before {
            content: '';
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #333;
            z-index: 1000;
        }

        .user-info-display {
            border: 2px solid #fff; /* Changed from #0f0 to white by default */
            background: #333;
            padding: 10px 20px;
            text-align: center;
            font-size: 1rem;
            margin: 5px 0;
            min-width: 160px;
            box-sizing: border-box;
            font-family: "Poor Story", system-ui; /* Match other buttons */
            font-weight: 400;
            text-transform: uppercase;
        }

        .user-info-display.green-outline {
            border-color: #0f0;
            box-shadow: 0 0 15px #0f0;
        }

        

        .user-days {
            font-size: 0.9rem;
            color: #aaa;
        }

        .store-item.selected {
            background-color: #333;
            border: 2px solid #0f0;
        }

        .store-purchase-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 20px;
            align-items: center;
            background: #000;
            padding: 15px 30px;
            border: 2px solid #fff;
        }

        .total-price {
            font-size: 1.5rem;
            padding: 10px 20px;
            border: 2px solid #fff;
            background: #000;
        }

        .purchase-all-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            border: 2px solid #0f0;
            background: #0f0;
            color: #000;
            cursor: pointer;
            font-family: "Poor Story", system-ui;
            text-transform: uppercase;
        }

        .free-unlock {
            background: #0f0 !important;
            color: #000 !important;
            border-color: #0f0 !important;
        }

        .unlocks-text {
            font-size: 0.9rem;
            margin-bottom: 10px;
            color: #0f0;
        }

        .unit-light {
            position: absolute;
            top: -2px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }

        .unit-light svg {
            stroke-width: 2px;
            vertical-align: top;
        }

        .unit.lit-unit {
            background-color: #333333;
        }

        .unit.lit-unit .unit-light svg {
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.8));
        }

        

        @media (max-width: 768px) {
            #lobby-screen { 
                flex-direction: column;
                gap: 30px;
                padding-top: 100px;
                align-items: center;
            }
            
            #lobby-screen .news-board { 
                width: 90%; 
                height: 400px;
            }
            
            .navbar {
                padding: 10px 20px;
            }
            
            .navbar-title {
                font-size: 1.5rem;
            }
            
            .navbar-auth {
                gap: 10px;
                flex-wrap: wrap;
            }
            
            .lobby-btn, .user-info-display {
                padding: 8px 15px;
                min-width: 120px;
                font-size: 0.9rem;
            }

            .elevator-main-panel { flex-direction: column; }
            .elevator-panel { grid-template-columns: repeat(5, 1fr); max-width: 100%; }
            .elevator-side-controls { flex-direction: row; height: auto; width: 100%; justify-content: space-around; }
        }

    </style>
</head>
<body>
    <!-- Navigation Bar -->
        <nav class="navbar">
            <h1 class="navbar-title">227 Parking Ave</h1>
            <div class="navbar-auth">
                <button class="lobby-btn" id="sign-in-btn">Sign In with Google</button>
                <div class="user-info-display" id="user-info-display" style="display: none;">
                    Unit #<span id="user-unit-number">000</span>
                     / Day <span id="user-days-count">0</span>
                </div>
                <button class="lobby-btn" id="sign-out-btn" style="display:none;">Sign Out</button>
                <button class="lobby-btn" id="demo-data-btn">Create Demo Data</button>
                <button class="lobby-btn" id="clear-data-btn" style="background: #500;">Clear All Data</button>
            </div>
        </nav>

        <!-- All screens... -->
        <div id="lobby-screen" class="screen active">
            <div class="elevator-section">
                 <div class="elevator-door"></div>
                <div class="elevator-call-panel">
                    <button class="call-button" id="lobby-call-elevator-btn" data-tooltip="Call Elevator">▲</button>
                    <button class="call-button call-home-btn" id="lobby-call-home-btn" data-tooltip="Go to Your Unit" style="display: none;">H</button>
                    <div class="home-unit-display" id="home-unit-display" style="display: none;">
                        <div style="font-size: 1.2rem; text-align: center;">#000</div>
                    </div>
                </div>
            </div>
            <div class="news-board">
                <h1>Community News</h1>
                <div class="news-content">
                    <h2>Welcome to 227 Parking Ave!</h2>

                    <p>A minimalist, social apartment. Find your unit, settle in, and get to know your neighbors.</p>
                    <ul>
                        <li>Rules of the Complex:</li>
                        <li>1. Be kind, be respectful.</li>
                        <li>2. No heavy NSFW content.</li>
                        <li>3. Quiet hours are from 11 PM to 7 AM.</li>
                        <li>4. Upgrades Available Soon... ** Stay tuned!</li>
                    </ul>
                    <p>New Floors Added: We're expanding! The complex now reaches the <span id="max-floor-display">5th</span> floor. Welcome, new tenants!</p>
                    <p><strong>Update:</strong> The management kindly reminds tenants to keep the hallways clear of digital debris. Thank you for your cooperation.</p>
                    <p><strong>Notice:</strong> Scheduled maintenance on the main servers will occur this Sunday at 3 AM. Expect brief interruptions.</p>
                    <p><strong>Community Event:</strong> Join us for a virtual meet-and-greet on the roof deck (feature coming soon) next Friday!</p>
                </div>
                <div class="lobby-footer-controls">
                    <p class="lobby-footer">Total Residents: <span id="total-residents">0</span></p>
                    <button class="lobby-btn" id="store-btn">Store</button>
                </div>
            </div>
        </div>

        <div id="elevator-screen" class="screen">
             <h1 id="elevator-header">ELEVATOR</h1>
             <div class="elevator-top-indicator" id="elevator-floor-display">3</div>
             <div class="elevator-main-panel">
                <div class="elevator-panel" id="elevator-panel"></div>
                <div class="elevator-side-controls">
                    <button class="side-button" id="random-floor-btn">R</button>
                    <button class="side-button" id="floor-page-up" disabled>▲</button>
                    <button class="side-button call-home-btn" id="home-floor-btn-elevator">H</button>
                    <button class="side-button" id="floor-page-down" disabled>▼</button>
                </div>
            </div>
        </div>
        <div id="floor-screen" class="screen">
            <div class="travel-indicator" id="travel-indicator"></div>
            <div class="floor-hallway" id="floor-hallway"></div>
        </div>
        <div id="upstairs-screen" class="screen">
             <div id="upstairs-unit-container"></div>
             <div class="go-back-control" id="go-back-home-btn">
                 <span>CLICK DOWN TO GO BACK</span>
                 <div class="arrow"></div>
             </div>
        </div>

    <!-- Store Screen -->
    <div id="store-screen" class="screen">
        <h1 class="store-header">UPGRADE STORE</h1>
        <div class="store-items" id="store-items-container">
            <!-- Store items will be generated here -->
        </div>

        <div class="store-purchase-controls" id="store-purchase-controls">
            <div class="total-price" id="total-price">Total: $0.00</div>
            <button class="purchase-all-btn" id="purchase-all-btn">Purchase Selected</button>
            <button class="lobby-btn" id="clear-selection-btn">Clear Selection</button>
        </div>
        <button class="lobby-btn" id="back-to-lobby-btn" style="margin-top: 30px;">Back to Lobby</button>
    </div>

    <!-- Unit Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h2 id="edit-modal-title">Edit Your Unit</h2>
            <textarea id="edit-textarea"></textarea>
            <p id="char-count">Characters: 0 / 50</p>
            
            <div id="current-image-container">
                <p style="font-size: 0.9rem; color: #aaa;">Current Image:</p>
                <img id="current-image-preview" src="" alt="Current Unit Image">
                <button id="remove-image-btn">Remove Image</button>
            </div>

            <label for="image-upload" id="image-upload-label">Upload Image</label>
            <input type="file" id="image-upload" accept="image/*">
            <div id="image-preview-text">No file selected</div>

            <div class="image-options" id="image-options">
                <label><input type="radio" name="image-mode" value="bw" checked> B&W</label>
                <label><input type="radio" name="image-mode" value="color"> Color</label>
            </div>

            <div class="modal-actions">
                <button id="move-out-btn">Move Out</button>
                <div>
                    <button id="save-changes-btn">Save</button>
                    <button id="cancel-edit-btn">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
            // Hide demo buttons in production
            document.getElementById('demo-data-btn').style.display = 'none';
            document.getElementById('clear-data-btn').style.display = 'none';


        // --- Simulated User and Tenant Data ---
        let MY_UNIT_ID = null; //308;
        const MAX_FLOORS = 5;
        let MY_HOME_FLOOR = null; // Math.floor(MY_UNIT_ID / 100);
        let selectedUpgrades = [];


        const daysAgo = (days) => {
            const date = new Date();
            date.setDate(date.getDate() - days);
            return date.toISOString();
        };

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCIfUQLCobl2OSHYpOXkysk37dxZGl62iM",
          authDomain: "parkingave.firebaseapp.com",
          projectId: "parkingave",
          storageBucket: "parkingave.firebasestorage.app",
          messagingSenderId: "648031542086",
          appId: "1:648031542086:web:82566031526be74d366347"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        async function loadTenants() {
            try {
                console.log('Loading tenants from Firebase...');
                const snapshot = await db.collection('tenants').get();
                tenants = [];
                snapshot.forEach(doc => {
                    tenants.push({ id: doc.id, ...doc.data() });
                });
                renderLobby();
                console.log('Loaded tenants:', tenants.length);
            } catch (error) {
                console.error('Error loading tenants:', error);
            }
        }

        // Save tenant to Firebase
        async function saveTenant(tenant) {
            try {
                if (tenant.id) {
                    await db.collection('tenants').doc(tenant.id).update({
                        content: tenant.content,
                        imageUrl: tenant.imageUrl,
                        purchasedUpgrades: tenant.purchasedUpgrades,
                        lastActiveDate: tenant.lastActiveDate,
                        // Add any other fields that might change
                    });
                } else {
                    // Create new tenant
                    const docRef = await db.collection('tenants').add(tenant);
                    tenant.id = docRef.id;
                }
                console.log('Tenant saved successfully');
            } catch (error) {
                console.error('Error saving tenant:', error);
            }
        }

        // Update tenant content
        async function updateTenantContent(unitId, content, imageUrl = null) {
            try {
                const tenant = tenants.find(t => t.unitId === unitId);
                if (tenant) {
                    tenant.content = content;
                    if (imageUrl !== null) {
                        tenant.imageUrl = imageUrl;
                    }
                    await saveTenant(tenant);
                }
            } catch (error) {
                console.error('Error updating tenant:', error);
            }
        }

        // Delete tenant (move out)
        async function deleteTenant(userId) {
            try {
                const tenant = tenants.find(t => t.userId === userId);
                if (tenant && tenant.id) {
                    await db.collection('tenants').doc(tenant.id).delete();
                    tenants = tenants.filter(t => t.userId !== userId);
                    console.log('Tenant deleted successfully');
                }
            } catch (error) {
                console.error('Error deleting tenant:', error);
            }
        }

        let upgrades = [];

        async function loadUpgrades() {
            try {
                const snapshot = await db.collection('config').get();
                upgrades = [];
                
                snapshot.forEach(doc => {
                    const upgradeData = doc.data();
                    // Add the document ID as the upgrade ID
                    upgradeData.id = doc.id;
                    upgrades.push(upgradeData);
                });
                
                console.log('Loaded upgrades:', upgrades);
            } catch (error) {
                console.error('Failed to load upgrades:', error);
                // Fallback to empty array or basic config
                upgrades = [];
            }
        }


        // --- State Management & DOM Elements ---
        let currentView = 'lobby';
        let currentFloor = 1;
        let editingUnitId = null;
        let selectedFile = null;
        let removeImage = false;
        let signedInUser = null; // This will hold the signed-in tenant object

        const screens = document.querySelectorAll('.screen');
        const lobbyCallElevatorBtn = document.getElementById('lobby-call-elevator-btn');
        const lobbyCallHomeBtn = document.getElementById('lobby-call-home-btn');
        const elevatorFloorDisplay = document.getElementById('elevator-floor-display');
        const elevatorPanel = document.getElementById('elevator-panel');
        const randomFloorBtn = document.getElementById('random-floor-btn');
        const homeFloorBtnElevator = document.getElementById('home-floor-btn-elevator');
        const floorHallway = document.getElementById('floor-hallway');
        const travelIndicator = document.getElementById('travel-indicator');
        const upstairsScreenContainer = document.getElementById('upstairs-unit-container');
        const goBackHomeBtn = document.getElementById('go-back-home-btn');
        const editModal = document.getElementById('edit-modal');
        const editModalTitle = document.getElementById('edit-modal-title');
        const editTextArea = document.getElementById('edit-textarea');
        const charCount = document.getElementById('char-count');
        const imageUploadInput = document.getElementById('image-upload');
        const imageUploadLabel = document.getElementById('image-upload-label');
        const imagePreviewText = document.getElementById('image-preview-text');
        const imageOptions = document.getElementById('image-options');
        const currentImageContainer = document.getElementById('current-image-container');
        const currentImagePreview = document.getElementById('current-image-preview');
        const removeImageBtn = document.getElementById('remove-image-btn');
        const moveOutBtn = document.getElementById('move-out-btn');
        const saveChangesBtn = document.getElementById('save-changes-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const signInBtn = document.getElementById('sign-in-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const storeBtn = document.getElementById('store-btn');
        const storeItemsContainer = document.getElementById('store-items-container');
        const backToLobbyBtn = document.getElementById('back-to-lobby-btn'); 

        
        // --- Core Logic & Functions ---
        function switchView(viewName) {
            currentView = viewName;
            screens.forEach(screen => {
                screen.classList.toggle('active', screen.id === `${viewName}-screen`);
            });

            const navbar = document.querySelector('.navbar');
            if (navbar) {
                navbar.classList.toggle('show', viewName === 'lobby');
            }
            
            if (viewName === 'lobby') {
                renderLobby();
            }
        }
        function getDaysStayed(moveInDate) {
            const startDate = new Date(moveInDate);
            const today = new Date();
            const diffTime = Math.abs(today - startDate);
            const days = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return Math.max(1, days);
        }
        function getCharLimit(tenant) {
            if (!tenant) return 0;
            const days = getDaysStayed(tenant.moveInDate);
            const naturalLimit = Math.min(50, 10 + Math.floor(Math.max(0, days - 1) / 7) * 5);
            
            if (tenant.purchasedUpgrades.includes('char-200')) return 200;
            if (tenant.purchasedUpgrades.includes('char-100')) return 100;
            
            return naturalLimit;
        }

        function pixelateImage(file, pixelationFactor = 64, mode = 'color') {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const size = Math.min(img.width, img.height);
                        const sx = (img.width - size) / 2;
                        const sy = (img.height - size) / 2;
                        const smallCanvas = document.createElement('canvas');
                        smallCanvas.width = pixelationFactor;
                        smallCanvas.height = pixelationFactor;
                        const smallCtx = smallCanvas.getContext('2d');
                        smallCtx.drawImage(img, sx, sy, size, size, 0, 0, pixelationFactor, pixelationFactor);
                        const outputSize = 200;
                        canvas.width = outputSize;
                        canvas.height = outputSize;
                        ctx.imageSmoothingEnabled = false;
                        ctx.drawImage(smallCanvas, 0, 0, pixelationFactor, pixelationFactor, 0, 0, outputSize, outputSize);
                        if (mode === 'bw') {
                            const imageData = ctx.getImageData(0, 0, outputSize, outputSize);
                            const data = imageData.data;
                            for (let i = 0; i < data.length; i += 4) {
                                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                                data[i] = avg; data[i + 1] = avg; data[i + 2] = avg;
                            }
                            ctx.putImageData(imageData, 0, 0);
                        }
                        resolve(canvas.toDataURL());
                    };
                    img.onerror = reject;
                    img.src = event.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function getOrdinalNumber(n) {
            const suffixes = ["th", "st", "nd", "rd"];
            const v = n % 100;
            return n + (suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0]);
        }

        function renderLobby() { 
            document.getElementById('total-residents').textContent = tenants.length;
            document.getElementById('max-floor-display').textContent = getOrdinalNumber(MAX_FLOORS);
            
            // Show/hide user info based on sign-in status
            const userInfoDisplay = document.getElementById('user-info-display');
            if (signedInUser && userInfoDisplay) {
                userInfoDisplay.style.display = 'block';
                lobbyCallHomeBtn.style.display = 'block';
                document.getElementById('user-unit-number').textContent = MY_UNIT_ID;
                document.getElementById('user-days-count').textContent = getDaysStayed(signedInUser.moveInDate);
            } else {
                if (userInfoDisplay) userInfoDisplay.style.display = 'none';
                lobbyCallHomeBtn.style.display = 'none';
            }
        }

        // --- View Rendering & Animation ---
        function renderElevator() {
            const randomBtn = document.getElementById('random-floor-btn');
            const homeBtn = document.getElementById('home-floor-btn-elevator');
            if (randomBtn) randomBtn.setAttribute('data-tooltip', 'Random Floor');
            if (homeBtn) homeBtn.setAttribute('data-tooltip', 'Go Home');
            elevatorFloorDisplay.textContent = (currentFloor === 1) ? 'L' : currentFloor;
            elevatorPanel.innerHTML = '';
            for (let i = 1; i <= 20; i++) {
                const button = document.createElement('button');
                button.className = 'floor-button';
                button.textContent = (i === 1) ? 'L' : i;
                if (i === currentFloor) button.classList.add('active');
                if (i > MAX_FLOORS && i !== 1) button.disabled = true;
                button.dataset.floor = i;
                elevatorPanel.appendChild(button);
            }
            homeFloorBtnElevator.disabled = !signedInUser || currentFloor === MY_HOME_FLOOR;
            homeFloorBtnElevator.classList.toggle('home-disabled', !signedInUser || currentFloor === MY_HOME_FLOOR);
        }

        function createUnitHTML(unitId, isUpstairsView = false) {
            const tenant = tenants.find(t => t.unitId === unitId);
            let homeLabel = (signedInUser && unitId === MY_UNIT_ID) ? ' / HOME' : '';

            const isLit = tenant ? isUserActiveToday(tenant) : false;

            if (tenant && unitId === MY_UNIT_ID) {
                    console.log('DEBUG - My Unit:', unitId);
                    console.log('DEBUG - Tenant:', tenant);
                    console.log('DEBUG - lastActiveDate:', tenant.lastActiveDate);
                    console.log('DEBUG - isLit:', isLit);
                    console.log('DEBUG - Today:', new Date().toDateString());
                }

            const lightSVG = isLit ? getLitLightSVG() : getUnlitLightSVG();

            if (!tenant) {
                return `<div class="unit vacant">
                    <div class="unit-light">${lightSVG}</div>
                    <div class="unit-header">
                        <span>UNIT # ${unitId}</span>
                        <span>VACANT</span>
                    </div>
                    <div class="unit-content">
                        <div class="unit-text">VACANT</div>
                    </div>
                </div>`;
            }


            let upstairsArrowHTML = '';
            if (signedInUser && unitId === MY_UNIT_ID && !isUpstairsView) {
                const upstairsTenant = tenants.find(t => t.unitId === MY_UNIT_ID + 100);
                if (upstairsTenant) {
                    upstairsArrowHTML = `<div class="view-upstairs-arrow" data-upstairs-unitid="${MY_UNIT_ID + 100}"></div>`;
                }
            }
            
            let imageHTML = '';
            if (tenant.imageUrl) {
                imageHTML = `<div class="unit-image-container"><img src="${tenant.imageUrl}" alt="Unit Image"></div>`;
            }

            let outlineClass = '';
            if (tenant.purchasedUpgrades.includes('outline-green')) {
                outlineClass = 'green-outline';
            }


            return `
                <div class="unit ${homeLabel ? 'my-unit' : ''} ${outlineClass} ${isLit ? 'lit-unit' : ''}">
                    <div class="unit-light">${lightSVG}</div>
                    ${upstairsArrowHTML}
                    <div class="unit-header">
                        <span>UNIT # ${unitId}${homeLabel}</span>
                        <span>DAY ${getDaysStayed(tenant.moveInDate)}</span>
                    </div>
                    <div class="unit-content">
                        ${imageHTML}
                        <div class="unit-text">${tenant.content}</div>
                    </div>
                    ${homeLabel ? `<button class="edit-button" data-unitid="${unitId}">EDIT</button>` : ''}
                </div>`;
        }

        // When user signs in or takes any action
        async function updateUserActivity(tenant) {
            if (!tenant) return;
            const today = new Date().toDateString(); // "Mon Dec 09 2024"
            tenant.lastActiveDate = today;
            saveTenant(tenant);

            try {
                await saveTenant(tenant);
                console.log('Updated activity for:', tenant.unitId, 'Date:', today);
            } catch (error) {
                console.error('Failed to update activity:', error);
            }
        }

        // Check if user was active today
        function isUserActiveToday(tenant) {
            if (!tenant.lastActiveDate) return false;
            const today = new Date().toDateString();
            return tenant.lastActiveDate === today;
        }

        function checkMidnightReset() {
            const now = new Date();
            const estTime = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
            const hour = estTime.getHours();
            const minute = estTime.getMinutes();
            
            // If it's midnight EST (00:00)
            if (hour === 0 && minute === 0) {
                // Re-render all views to update lights
                if (currentView === 'floor') renderFloorView();
                if (currentView === 'lobby') renderLobby();
            }
        }

        setInterval(checkMidnightReset, 60000);

        function getLitLightSVG() {
            return `<svg width="60" height="30" viewBox="0 0 60 30" fill="none" xmlns="http://www.w3.org/2000/svg">
                <!-- Light fixture base - no top line, only sides and bottom -->
                <line x1="11" y1="2" x2="11" y2="8" stroke="white" stroke-width="2"/>
                <line x1="49" y1="2" x2="49" y2="8" stroke="white" stroke-width="2"/>
                <line x1="10" y1="8" x2="50" y2="8" stroke="white" stroke-width="2"/>
                <!-- Light bulb -->
                <path d="M15 8 L45 8 C45 16 38 22 30 22 C22 22 15 16 15 8 Z" fill="white" stroke="white" stroke-width="2"/>
            </svg>`;
        }

        function getUnlitLightSVG() {
            return `<svg width="60" height="30" viewBox="0 0 60 30" fill="none" xmlns="http://www.w3.org/2000/svg">
                <!-- Light fixture base - no top line, only sides and bottom -->
                <line x1="11" y1="2" x2="11" y2="8" stroke="white" stroke-width="2"/>
                <line x1="49" y1="2" x2="49" y2="8" stroke="white" stroke-width="2"/>
                <line x1="10" y1="8" x2="50" y2="8" stroke="white" stroke-width="2"/>
                <!-- Smaller light bulb (outline only) -->
                <path d="M15 8 L45 8 C45 16 38 22 30 22 C22 22 15 16 15 8 Z" fill="none" stroke="white" stroke-width="2"/>
            </svg>`;
        }

        function renderFloorView() {
            floorHallway.innerHTML = '';
            for (let i = 1; i <= 5; i++) { floorHallway.innerHTML += createUnitHTML(currentFloor * 100 + i); }

            const upButtonHTML = currentFloor < MAX_FLOORS ? '<button class="call-button" id="call-up" data-tooltip="Go Up">▲</button>' : '';

            const homeButtonHTML = signedInUser ? `<button class="call-button call-home-btn ${currentFloor === MY_HOME_FLOOR ? 'home-active' : ''}" id="call-home" data-tooltip="${currentFloor === MY_HOME_FLOOR ? 'You Are Home' : 'Go to Your Home Floor'}">H</button>` : '';

            floorHallway.innerHTML += `
                <div class="elevator-section" id="elevator-section">
                    <div class="hallway-floor-display">${currentFloor}</div>
                    <div class="elevator-door"></div>
                    <div class="elevator-call-panel">
                        ${upButtonHTML}
                        ${homeButtonHTML}

                        <button class="call-button" id="call-down" data-tooltip="Go Down">▼</button>
                    </div>
                </div>`;

            for (let i = 6; i <= 10; i++) { floorHallway.innerHTML += createUnitHTML(currentFloor * 100 + i); }

            if (signedInUser) {
                updateUserActivity(signedInUser);
            }

            setTimeout(() => {
                const elevator = document.getElementById('elevator-section');
                if (elevator) {
                    const screenCenter = window.innerWidth / 2;
                    const elevatorCenter = elevator.offsetLeft + elevator.offsetWidth / 2;
                    floorHallway.style.left = `${screenCenter - elevatorCenter}px`;
                }
                
                const allUnitContents = floorHallway.querySelectorAll('.unit-content');

                allUnitContents.forEach(content => {
                    const unit = content.closest('.unit');
                    const isMyUnit = unit.classList.contains('my-unit');
                    
                    if (content.scrollHeight > content.clientHeight) {
                        content.style.justifyContent = 'flex-start';
                        // For own units with scrollable content, ensure extra bottom padding
                        if (isMyUnit) {
                            content.style.paddingBottom = '80px'; // Extra space for edit button
                        }
                    } else {
                        content.style.justifyContent = 'center';
                    }
                });
            }, 0);
        }

        async function handleGoogleSignIn(response) {
            // Decode the JWT token to get user info
            const userInfo = JSON.parse(atob(response.credential.split('.')[1]));
            
            // Check if user already exists
            let existingUser = tenants.find(t => t.userId === userInfo.sub);
            
            if (existingUser) {
                // Existing user
                signedInUser = existingUser;
                MY_UNIT_ID = signedInUser.unitId;
                MY_HOME_FLOOR = Math.floor(MY_UNIT_ID / 100);
                await updateUserActivity(signedInUser);
            } else {
                // New user - find vacant unit
                const vacantUnit = findVacantUnit();
                if (vacantUnit) {
                    const newTenant = {
                        userId: userInfo.sub,
                        name: userInfo.name,
                        email: userInfo.email,
                        picture: userInfo.picture,
                        unitId: vacantUnit,
                        moveInDate: new Date().toISOString(),
                        content: "JUST MOVED IN!",
                        imageUrl: null,
                        purchasedUpgrades: []
                    };

                    // Save to Firebase
                    await saveTenant(newTenant);
                    tenants.push(newTenant);
                    signedInUser = newTenant;
                    MY_UNIT_ID = signedInUser.unitId;
                    MY_HOME_FLOOR = Math.floor(MY_UNIT_ID / 100);
                    await updateUserActivity(newTenant);
                } else {
                    alert("Sorry, no vacant units available!");
                    return;
                }
            }
            
            signInBtn.style.display = 'none';
            signOutBtn.style.display = 'block';
            lobbyCallHomeBtn.disabled = false;
            renderLobby();

            if (currentView === 'floor') {
                renderFloorView();
            }
        }

        function initializeGoogleSignIn() {
            if (typeof google !== 'undefined' && google.accounts) {
                google.accounts.id.initialize({
                    client_id: 'PLACEHOLDER_CLIENT_ID', 
                    callback: handleGoogleSignIn,
                    auto_select: false, // This ensures account picker shows
                    cancel_on_tap_outside: false
                });
            }
        }

        function findVacantUnit() {
            for (let floor = 2; floor <= MAX_FLOORS; floor++) {
                for (let unit = 1; unit <= 10; unit++) {
                    const unitId = floor * 100 + unit;
                    if (!tenants.find(t => t.unitId === unitId)) {
                        return unitId;
                    }
                }
            }
            return null;
        }

        function renderStore() {
            storeItemsContainer.innerHTML = '';
            if (!signedInUser) return;
            const days = getDaysStayed(signedInUser.moveInDate);

            upgrades.forEach(upgrade => {
                const isPurchased = signedInUser.purchasedUpgrades.includes(upgrade.id);
                const isUnlockedByTime = days >= upgrade.daysToUnlock;
                let isPrereqMet = true;
                if (upgrade.requires) {
                    isPrereqMet = signedInUser.purchasedUpgrades.includes(upgrade.requires);
                }
                
                let actionHTML = '';
                let unlockStatusHTML = '';
                
                if (isPurchased) {
                    actionHTML = `<div class="unlocked-label">PURCHASED</div>`;
                } else if (isUnlockedByTime && isPrereqMet) {
                    unlockStatusHTML = `<div class="unlocks-text">UNLOCKED - FREE</div>`;
                    actionHTML = `<button class="price-btn free-unlock" data-upgradeid="${upgrade.id}">UNLOCK FREE</button>`;
                } else if (!isPrereqMet) {
                    daysLeft = upgrade.daysToUnlock - days;
                    unlockStatusHTML = `<div class="unlocks-text">${daysLeft} days left to unlock</div>`;
                    const prereqUpgrade = upgrades.find(u => u.id === upgrade.requires);
                    actionHTML = `<div class="locked-label">REQUIRES: ${prereqUpgrade.name}</div>`;
                } else {
                    const daysLeft = upgrade.daysToUnlock - days;
                    unlockStatusHTML = `<div class="unlocks-text">${daysLeft} days left to unlock</div>`;
                    actionHTML = `<button class="price-btn" data-upgradeid="${upgrade.id}">BUY NOW - $${upgrade.price.toFixed(2)}</button>`;

                    //check if this is purchasable
                    if (upgrade.purchasable) {
                        actionHTML = `<button class="price-btn" data-upgradeid="${upgrade.id}">BUY NOW - $${upgrade.price.toFixed(2)}</button>`;
                    } else {
                        actionHTML = `<div class="locked-label">UNLOCK IN ${daysLeft} DAYS</div>`;
                    }
                }

                storeItemsContainer.innerHTML += `
                    <div class="store-item" data-upgradeid="${upgrade.id}">
                        <div class="item-info">
                            <h3>${upgrade.name}</h3>
                            <p>${upgrade.description}</p>
                        </div>
                        <div class="item-action">
                            ${unlockStatusHTML}
                            ${actionHTML}
                        </div>
                    </div>
                `;
            });
        }

        function renderUpstairsView() {
             const upstairsUnitId = MY_UNIT_ID + 100;
             upstairsScreenContainer.innerHTML = createUnitHTML(upstairsUnitId, true);
        }
        function animateFloorTravel(fromFloor, toFloor) {
            switchView('floor');
            floorHallway.style.opacity = '0';
            travelIndicator.textContent = fromFloor === 1 ? 'L' : fromFloor;
            travelIndicator.classList.add('visible');
            let floor = fromFloor;
            const direction = fromFloor < toFloor ? 1 : -1;
            const interval = setInterval(() => {
                floor += direction;
                travelIndicator.textContent = floor === 1 ? 'L' : floor;
                if (floor === toFloor) {
                    clearInterval(interval);
                    setTimeout(() => {
                        travelIndicator.classList.remove('visible');
                        if (toFloor === 1) {
                            
                            switchView('lobby');
                        } else {
                            
                            renderFloorView();
                            floorHallway.style.opacity = '1';
                        }
                    }, 300);
                }
            }, 150);
        }

        async function createDemoData() {
            
            const snapshot = await db.collection('tenants').where('userId', '==', 'demo1').get();
            if (!snapshot.empty) {
                console.log('Demo data already exists');
                await loadTenants();
                return;
            }

            console.log('Creating demo data...');
            
            const daysAgo = (days) => {
                const date = new Date();
                date.setDate(date.getDate() - days);
                return date.toISOString();
            };

            const demoTenants = [
                { userId: 'demo1', unitId: 308, moveInDate: daysAgo(64), content: "BEEN HERE A COUPLE OF MONTHS. IT'S QUIET. I LIKE IT.", imageUrl: null, purchasedUpgrades: [], name: 'Demo User', email: 'demo@example.com' },
                { userId: 'demo2', unitId: 201, moveInDate: daysAgo(120), content: "ORIGINAL TENANT.", imageUrl: null, purchasedUpgrades: ['outline-green'], name: 'First Resident', email: 'first@example.com' },
                { userId: 'demo3', unitId: 202, moveInDate: daysAgo(5), content: "JUST MOVED IN!", imageUrl: null, purchasedUpgrades: [], name: 'New Tenant', email: 'new@example.com' },
                { userId: 'demo4', unitId: 204, moveInDate: daysAgo(18), content: "HELLO NEIGHBORS!", imageUrl: null, purchasedUpgrades: [], name: 'Friendly Person', email: 'friendly@example.com' },
            ];

            try {
                for (const tenant of demoTenants) {
                    await db.collection('tenants').add(tenant);
                }
                console.log('Demo data created successfully!');
                await loadTenants(); // Reload the data
            } catch (error) {
                console.error('Error creating demo data:', error);
            }
        }

        async function simulateSignIn() {

            console.log('Attempting demo sign-in...');
                
            // Check if we have any tenants loaded
            if (tenants.length === 0) {
                console.log('No tenants found, creating demo data...');
                await createDemoData();
            }

            let demoUser = tenants.find(t => t.userId === 'demo1');
                
            if (demoUser) {
                signedInUser = demoUser;
                MY_UNIT_ID = signedInUser.unitId;
                MY_HOME_FLOOR = Math.floor(MY_UNIT_ID / 100);
                signInBtn.style.display = 'none';
                signOutBtn.style.display = 'block';
                lobbyCallHomeBtn.disabled = false;
                renderLobby();
                alert('Demo sign-in successful! (Using demo account)');
                console.log('Demo sign-in successful:', demoUser);
                await updateUserActivity(signedInUser);
            } else {
                console.error('Demo user not found even after creating demo data');
                alert('Demo sign-in failed - check console for errors');
            }

            if (currentView === 'floor') {
                renderFloorView();
            }
        }

        async function clearAllData() {
            if (!confirm('Are you sure you want to delete ALL tenant data? This cannot be undone!')) {
                return;
            }
            
            try {
                console.log('Deleting all tenant data...');
                const snapshot = await db.collection('tenants').get();
                
                // Delete all documents
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                // Clear local data
                tenants = [];
                signedInUser = null;
                MY_UNIT_ID = null;
                MY_HOME_FLOOR = null;
                
                // Reset UI
                signInBtn.style.display = 'block';
                signOutBtn.style.display = 'none';
                renderLobby();
                
                alert('All data cleared successfully!');
                console.log('All data cleared');
            } catch (error) {
                console.error('Error clearing data:', error);
                alert('Error clearing data: ' + error.message);
            }
        }

        function updatePurchaseControls() {
            const controls = document.getElementById('store-purchase-controls');
            const totalPrice = document.getElementById('total-price');
            const purchaseBtn = document.getElementById('purchase-all-btn');
            
            if (selectedUpgrades.length === 0) {
                controls.style.display = 'none';
                return;
            }
            
            controls.style.display = 'flex';
            const total = selectedUpgrades.reduce((sum, upgradeId) => {
                const upgrade = upgrades.find(u => u.id === upgradeId);
                return sum + upgrade.price;
            }, 0);
            
            totalPrice.textContent = `Total: $${total.toFixed(2)}`;
            purchaseBtn.textContent = selectedUpgrades.length === 1 ? 
                'Purchase Item' : `Purchase ${selectedUpgrades.length} Items`;
        }

        document.getElementById('purchase-all-btn').addEventListener('click', async () => {
            if (signedInUser && selectedUpgrades.length > 0) {
                // Add all selected upgrades
                for (const upgradeId of selectedUpgrades) {
                    await unlockUpgrade(upgradeId, false); // false = paid purchase
                }
                
                // Clear selection
                selectedUpgrades = [];
                document.querySelectorAll('.store-item').forEach(item => item.classList.remove('selected'));
                document.getElementById('store-purchase-controls').style.display = 'none';
                
                alert('All purchases completed successfully!');
            }
        });

        document.getElementById('clear-data-btn').addEventListener('click', clearAllData);

        document.getElementById('demo-data-btn').addEventListener('click', async () => {
            await createDemoData();
            alert('Demo data created! Try signing in now.');
        });

        document.addEventListener('click', (e) => {
            if (e.target.matches('.call-home-btn')) {
                        console.log('HOME BUTTON CLICKED - currentFloor:', currentFloor, 'MY_HOME_FLOOR:', MY_HOME_FLOOR, 'signedInUser:', !!signedInUser);
                if (!signedInUser) return;
                
                // Don't animate if already on home floor
                if (currentFloor === MY_HOME_FLOOR) {
                    console.log('ALREADY HOME - no animation');
                    return;
                }
                
                const fromFloor = currentFloor;
                currentFloor = MY_HOME_FLOOR;
                animateFloorTravel(fromFloor, MY_HOME_FLOOR);
            }
        });

        // --- Event Listeners ---
        function setupEventListeners() {
            if (signInBtn) {
                signInBtn.addEventListener('click', () => {
                    if (window.location.protocol !== 'file:') {
                        google.accounts.id.initialize({
                            client_id: 'PLACEHOLDER_CLIENT_ID',
                            callback: handleGoogleSignIn
                        });
                        
                        // This will show the account picker popup
                        google.accounts.id.prompt();
                    } else {
                        console.log('BEFORE SIGN IN - currentFloor:', currentFloor, 'MY_HOME_FLOOR:', MY_HOME_FLOOR, 'MY_UNIT_ID:', MY_UNIT_ID);
                        // Fallback for demo/testing
                        simulateSignIn();
                        console.log('AFTER SIGN IN - currentFloor:', currentFloor, 'MY_HOME_FLOOR:', MY_HOME_FLOOR, 'MY_UNIT_ID:', MY_UNIT_ID);


                    }
                });
            }

            if (signOutBtn) {
                signOutBtn.addEventListener('click', () => {
                    signedInUser = null;
                    MY_UNIT_ID = null;
                    MY_HOME_FLOOR = null;
                    signInBtn.style.display = 'block';
                    signOutBtn.style.display = 'none';
                    lobbyCallHomeBtn.disabled = true;
                    renderLobby();
                });
            }

            if (storeBtn) {
                storeBtn.addEventListener('click', () => {
                    if(signedInUser) {
                        renderStore();
                        switchView('store');
                    } else {
                        alert("Please sign in to access the store.");
                    }
                });
            }

            if (backToLobbyBtn) {
                backToLobbyBtn.addEventListener('click', () => switchView('lobby'));
            }

            if (storeItemsContainer) {
                storeItemsContainer.addEventListener('click', (e) => {
                    if (e.target.matches('.price-btn')) {
                        const upgradeId = e.target.dataset.upgradeid;
                        const upgrade = upgrades.find(u => u.id === upgradeId);
                        const storeItem = e.target.closest('.store-item');
                        
                        // Handle free unlocks immediately
                        if (e.target.classList.contains('free-unlock')) {
                            unlockUpgrade(upgradeId, true); // true = free unlock
                            return;
                        }

                        // Check if this specific upgrade is purchasable
                        if (!upgrade.purchasable) {
                            alert('This upgrade can only be unlocked by waiting the required days.');
                            return;
                        }
                        
                        // Handle paid upgrades - add to cart
                        if (selectedUpgrades.includes(upgradeId)) {
                            // Deselect
                            selectedUpgrades = selectedUpgrades.filter(id => id !== upgradeId);
                            storeItem.classList.remove('selected');
                        } else {
                            // Select
                            selectedUpgrades.push(upgradeId);
                            storeItem.classList.add('selected');
                        }
                        
                        updatePurchaseControls();
                    }
                });
            }

            if (lobbyCallElevatorBtn) {
                lobbyCallElevatorBtn.addEventListener('click', () => { currentFloor = 1; renderElevator(); switchView('elevator'); });
            }
            
            if (elevatorPanel) {
                elevatorPanel.addEventListener('click', (e) => {
                    if (e.target.matches('.floor-button:not(:disabled)')) {
                        const fromFloor = currentFloor;
                        const targetFloor = parseInt(e.target.dataset.floor);
                        if (targetFloor === 1) {
                            currentFloor = 1; // Set current floor to lobby
                            animateFloorTravel(fromFloor, 1);
                            setTimeout(() => {
                                switchView('lobby');
                            }, (Math.abs(fromFloor - 1) * 150) + 300); // Calculate animation duration
                            return;  
                        }
                        currentFloor = targetFloor;
                        if (targetFloor !== fromFloor) { animateFloorTravel(fromFloor, targetFloor); } 
                        else { renderFloorView(); switchView('floor'); }
                    }
                });
            }

            if (randomFloorBtn) {
                randomFloorBtn.addEventListener('click', () => {
                    const fromFloor = currentFloor;
                    const possibleFloors = Array.from({length: MAX_FLOORS - 1}, (_, i) => i + 2);
                    const validFloors = possibleFloors.filter(floor => floor !== currentFloor);
                    if (validFloors.length > 0) {
                        const randomFloor = validFloors[Math.floor(Math.random() * validFloors.length)];
                        currentFloor = randomFloor;
                        animateFloorTravel(fromFloor, randomFloor);
                    }
                });
            }

            async function unlockUpgrade(upgradeId, isFree = false) {
                if (!signedInUser.purchasedUpgrades.includes(upgradeId)) {
                    signedInUser.purchasedUpgrades.push(upgradeId);
                    
                    // Save to Firebase
                    try {
                        await saveTenant(signedInUser);
                        console.log(`Upgrade ${upgradeId} ${isFree ? 'unlocked for free' : 'purchased'}!`);
                        
                        // Refresh store display
                        renderStore();
                        
                        // Clear selection if it was a purchase
                        if (!isFree) {
                            selectedUpgrades = selectedUpgrades.filter(id => id !== upgradeId);
                            updatePurchaseControls();
                        }
                        
                        alert(`${isFree ? 'Unlocked for free' : 'Purchased'}: ${upgrades.find(u => u.id === upgradeId).name}!`);
                    } catch (error) {
                        console.error('Error saving upgrade:', error);
                        alert('Error saving upgrade. Please try again.');
                    }
                }
            }


            document.getElementById('floor-screen').addEventListener('wheel', (e) => {
                const unitContent = e.target.closest('.unit-content');
                if (unitContent && unitContent.scrollHeight > unitContent.clientHeight) {
                    return;
                }
                e.preventDefault();
                const hallway = floorHallway;
                const currentLeft = parseFloat(hallway.style.left) || 0;
                
                // Support both vertical wheel (deltaY) and horizontal wheel (deltaX)
                const delta = e.deltaY !== 0 ? e.deltaY : e.deltaX;
                let newLeft = currentLeft - delta * 2.5;
                
                const screenWidth = window.innerWidth;
                const hallwayWidth = hallway.scrollWidth;
                const maxLeft = 50; 
                const minLeft = screenWidth - hallwayWidth - 50;
                
                if (newLeft > maxLeft) newLeft = maxLeft;
                if (newLeft < minLeft) newLeft = minLeft;
                
                hallway.style.left = `${newLeft}px`;
            });

            document.addEventListener('keydown', (e) => {
                if (currentView !== 'floor') return;
                
                if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    e.preventDefault();
                    
                    const hallway = floorHallway;
                    const currentLeft = parseFloat(hallway.style.left) || 0;
                    const unitWidth = 540; // 500px unit + 40px gap
                    const direction = e.key === 'ArrowLeft' ? 1 : -1;
                    let newLeft = currentLeft + (unitWidth * direction);
                    
                    const screenWidth = window.innerWidth;
                    const hallwayWidth = hallway.scrollWidth;
                    const maxLeft = 50;
                    const minLeft = screenWidth - hallwayWidth - 50;
                    
                    if (newLeft > maxLeft) newLeft = maxLeft;
                    if (newLeft < minLeft) newLeft = minLeft;
                    
                    hallway.style.transition = 'left 0.3s ease';
                    hallway.style.left = `${newLeft}px`;
                    
                    // Remove transition after animation
                    setTimeout(() => {
                        hallway.style.transition = '';
                    }, 300);
                }
            });

            let touchStartX = 0;
            let touchStartLeft = 0;

            floorHallway.addEventListener('touchstart', (e) => {
                if (currentView !== 'floor') return;
                touchStartX = e.touches[0].clientX;
                touchStartLeft = parseFloat(floorHallway.style.left) || 0;
            });

            floorHallway.addEventListener('touchmove', (e) => {
                if (currentView !== 'floor') return;
                e.preventDefault();
                
                const touchX = e.touches[0].clientX;
                const deltaX = touchX - touchStartX;
                let newLeft = touchStartLeft + deltaX;
                
                const screenWidth = window.innerWidth;
                const hallwayWidth = floorHallway.scrollWidth;
                const maxLeft = 50;
                const minLeft = screenWidth - hallwayWidth - 50;
                
                if (newLeft > maxLeft) newLeft = maxLeft;
                if (newLeft < minLeft) newLeft = minLeft;
                
                floorHallway.style.left = `${newLeft}px`;
            });

            floorHallway.addEventListener('click', (e) => {
                const callButton = e.target.closest('.call-button');
                if (callButton) {
                     if (callButton.id === 'call-up' || callButton.id === 'call-down' || (callButton.id === 'call-home' && !callButton.classList.contains('home-active'))) {
                        renderElevator();
                        switchView('elevator');
                    }
                }
                const editButton = e.target.closest('.edit-button');
                if (editButton) {
                    editingUnitId = parseInt(editButton.dataset.unitid);
                    const tenant = tenants.find(t => t.unitId === editingUnitId);
                    if (tenant) {
                        const charLimit = getCharLimit(tenant);
                        const hasImageAccess = tenant.purchasedUpgrades.includes('image-bw') || tenant.purchasedUpgrades.includes('image-color');
                        
                        editModalTitle.textContent = `EDIT UNIT #${editingUnitId}`;
                        editTextArea.value = tenant.content;
                        editTextArea.maxLength = charLimit;
                        charCount.textContent = `${tenant.content.length} / ${charLimit}`;
                        
                        // Hide/show image upload based on access
                        const imageUploadSection = document.getElementById('image-upload-label');
                        const imagePreview = document.getElementById('image-preview-text');
                        const imageOptions = document.getElementById('image-options');
                        
                        if (hasImageAccess) {
                            imageUploadSection.style.display = 'block';
                            imagePreview.style.display = 'block';
                            // ... rest of image logic
                        } else {
                            imageUploadSection.style.display = 'none';
                            imagePreview.style.display = 'none';
                            imageOptions.style.display = 'none';
                        }
                        
                        // ... rest of existing logic
                        editModal.style.display = 'flex';
                    }
                }
                const upstairsArrow = e.target.closest('.view-upstairs-arrow');
                if (upstairsArrow) {
                    renderUpstairsView();
                    switchView('upstairs');
                }
            });

            goBackHomeBtn.addEventListener('click', () => { switchView('floor'); });
            
            editTextArea.addEventListener('input', () => {
                if (!signedInUser) return;
                const charLimit = getCharLimit(signedInUser);
                charCount.textContent = `${editTextArea.value.length} / ${charLimit}`;
            });

            imageUploadInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    selectedFile = e.target.files[0];
                    imagePreviewText.textContent = selectedFile.name;
                    imageOptions.style.display = 'flex';
                    currentImageContainer.style.display = 'none';
                    removeImageBtn.style.display = 'none';
                }
            });
            removeImageBtn.addEventListener('click', () => {
                removeImage = true;
                currentImageContainer.style.display = 'none';
                removeImageBtn.style.display = 'none';
                imageUploadLabel.textContent = 'Upload Image';
            });
            moveOutBtn.addEventListener('click', () => {
                if (signedInUser) {
                    const index = tenants.findIndex(t => t.userId === signedInUser.userId);
                    if (index > -1) {
                        tenants.splice(index, 1);
                        signOutBtn.click(); // Simulate signing out
                        renderLobby();
                        editModal.style.display = 'none';
                        alert('You have moved out. Your unit is now vacant.');
                    }
                }
            });
            saveChangesBtn.addEventListener('click', async () => {
                if (editingUnitId === null) return;
                const tenant = tenants.find(t => t.unitId === editingUnitId);
                if (!tenant) return;

                let newContent = editTextArea.value.toUpperCase();
                let newImageUrl = tenant.imageUrl;
                
                if (removeImage) {
                    tenant.imageUrl = null;
                } else if (selectedFile) {
                    try {
                        const imageMode = document.querySelector('input[name="image-mode"]:checked').value;
                        const processedImageUrl = await pixelateImage(selectedFile, 64, imageMode);
                        tenant.imageUrl = processedImageUrl;
                    } catch (error) {
                        console.error("Image processing failed:", error);
                        imagePreviewText.textContent = "Error processing image.";
                    }
                }

                tenant.content = newContent;
                tenant.imageUrl = newImageUrl;

                await saveTenant(tenant);

                renderFloorView();
                editModal.style.display = 'none';
                editingUnitId = null;
                selectedFile = null;
                removeImage = false;
            });

            cancelEditBtn.addEventListener('click', () => { 
                editModal.style.display = 'none'; 
                editingUnitId = null;
                selectedFile = null;
                removeImage = false;
            });

            document.getElementById('purchase-all-btn').addEventListener('click', () => {
                if (signedInUser && selectedUpgrades.length > 0) {
                    selectedUpgrades.forEach(upgradeId => {
                        if (!signedInUser.purchasedUpgrades.includes(upgradeId)) {
                            signedInUser.purchasedUpgrades.push(upgradeId);
                        }
                    });
                    selectedUpgrades = [];
                    renderStore();
                    document.getElementById('store-purchase-controls').style.display = 'none';
                }
            });

            document.getElementById('clear-selection-btn').addEventListener('click', () => {
                selectedUpgrades = [];
                document.querySelectorAll('.store-item').forEach(item => item.classList.remove('selected'));
                document.getElementById('store-purchase-controls').style.display = 'none';
            });

        }
        // --- Initial Load ---
        async function init() {
            await loadTenants();
            await loadUpgrades();
            currentFloor = 1;
            setupEventListeners();
            switchView('lobby');

            if (signedInUser) {
                await updateUserActivity(signedInUser);
                if (currentView === 'floor') renderFloorView();
                if (currentView === 'lobby') renderLobby();
            }
        }
        init();
    </script>
</body>
</html>

