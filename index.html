<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>227 Parking Ave</title>

    <!-- Custom Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poor+Story&display=swap" rel="stylesheet">

    <script src="https://accounts.google.com/gsi/client" async defer></script>


    <style>
        /* General Body and Font Styles */
        body {
            font-family: "Poor Story", system-ui;
            font-weight: 400;
            font-style: normal;
            background-color: #000;
            color: #fff;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            text-transform: uppercase;
        }

        .screen {
            width: 100%;
            height: 100%;
            display: none; /* All screens hidden by default */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            position: absolute;
            top: 0;
            left: 0;
        }

        .screen.active {
            display: flex;
        }

        /* Lobby Screen Styles */
        #lobby-screen {
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 100px; /* Space between news and elevator */
            position: relative;
            padding-top: 180px; /* Increased padding to create space below the title */
            box-sizing: border-box;
        }
        .site-title {
            position: absolute;
            top: 40px; 
            left: 50%;
            font-size: 10rem;
            font-weight: 700;
            letter-spacing: 5px;
        }
        #lobby-screen .news-board {
            border: 2px solid #fff;
            padding: 20px 40px;
            background-color: #000;
            width: 600px;
            height: 480px; /* Adjusted height to prevent overlap */
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }
        #lobby-screen h1 { font-size: 2.5rem; margin-bottom: 10px; text-align: center; flex-shrink: 0; }
        .news-content {
            overflow-y: auto; /* Make content scrollable */
            padding-right: 20px; /* For scrollbar spacing */
        }
         /* Simple scrollbar styling for webkit browsers */
        .news-content::-webkit-scrollbar, .unit-content::-webkit-scrollbar, .modal::-webkit-scrollbar, .store-items::-webkit-scrollbar { width: 8px; }
        .news-content::-webkit-scrollbar-track, .unit-content::-webkit-scrollbar-track, .modal::-webkit-scrollbar-track, .store-items::-webkit-scrollbar-track { background: #000; }
        .news-content::-webkit-scrollbar-thumb, .unit-content::-webkit-scrollbar-thumb, .modal::-webkit-scrollbar-thumb, .store-items::-webkit-scrollbar-thumb { background: #555; border: 2px solid #000; }

        #lobby-screen h2 { margin-top: 0; font-size: 1.5rem; }
        #lobby-screen p, #lobby-screen ul { line-height: 1.6; font-size: 1rem; }
        #lobby-screen ul { padding-left: 20px; list-style-type: none; }
        #lobby-screen li { margin-bottom: 10px; }
        #lobby-screen .lobby-footer { margin-top: 30px; font-size: 1.2rem; }
        .lobby-buttons {
            position: absolute;
            top: 40px;
            right: 40px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .lobby-btn {
            border: 2px solid #fff;
            background: #000;
            color: #fff;
            padding: 10px 20px;
            font-family: "Poor Story", system-ui;
            font-weight: 400;
            font-style: normal;
            text-transform: uppercase;
            cursor: pointer;
            min-width: 160px;
            text-align: center;
        }

        /* Elevator Screen Styles */
        #elevator-screen { gap: 50px; flex-direction: column; }
        .elevator-top-indicator { border: 2px solid #fff; padding: 10px 40px; font-size: 2.5rem; }
        .elevator-main-panel { display: flex; gap: 30px; align-items: center; }
        .elevator-panel { display: grid; grid-template-columns: repeat(10, 1fr); gap: 15px; width: 100%; max-width: 800px; }
        .floor-button { border: 2px solid #fff; background: #000; color: #fff; font-size: 1.5rem; aspect-ratio: 1/1; cursor: pointer; }
        .floor-button.active { background: #fff; color: #000; }
        .floor-button:disabled { border-color: #555; color: #555; cursor: not-allowed; }
        .elevator-side-controls { display: flex; flex-direction: column; justify-content: space-between; align-items: center; height: 300px; }
        .side-button { border: 2px solid #fff; background: #000; color: #fff; width: 60px; height: 60px; font-size: 1.5rem; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .side-button:disabled { opacity: 0.5; }
        .side-button.home-disabled { background-color: #555; }


        /* Floor Screen Styles */
        #floor-screen {
            justify-content: initial;
            overflow: hidden;
            padding-top: 10vh; /* Pushes content down from the top */
        }
        .floor-hallway {
            display: flex;
            align-items: center;
            gap: 40px;
            padding: 0 50px;
            position: absolute;
            left: 0;
            transition: left 0.5s ease-out, opacity 0.3s ease-in-out;
        }
        .unit { border: 2px solid #fff; width: 500px; height: 500px; flex-shrink: 0; padding: 20px; box-sizing: border-box; position: relative; display: flex; flex-direction: column; }
        .unit.my-unit.green-outline { border-color: #0f0; box-shadow: 0 0 15px #0f0; }
        .unit.vacant { justify-content: center; align-items: center; font-size: 3rem; }
        .unit-header { display: flex; justify-content: space-between; font-size: 1.2rem; flex-shrink: 0; }
        .unit-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center; /* Default to center for short content */
            align-items: center;
            gap: 20px;
            overflow-y: auto; /* Make content scrollable */
            padding: 20px 10px 50px 10px; /* Added more padding-bottom for edit button */
            box-sizing: border-box;
        }
        .unit-image-container {
            width: 200px;
            height: 200px;
            border: 2px solid #fff;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .unit-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .unit-text {
            font-size: 1.8rem;
            word-wrap: break-word;
            white-space: pre-wrap;
            text-align: center;
            width: 100%;
        }
        .unit .edit-button { display: none; position: absolute; bottom: 20px; right: 20px; border: 2px solid #fff; background: #000; color: #fff; padding: 10px 20px; cursor: pointer; }
        .unit.my-unit:hover .edit-button { display: block; }
        .elevator-section { display: flex; align-items: center; gap: 20px; flex-shrink: 0; }
        .elevator-door { width: 200px; height: 500px; border: 2px solid #fff; display: flex; justify-content: center; align-items: center; }
        .elevator-door::before, .elevator-door::after { content: ''; position: absolute; width: 2px; height: 500px; background: #fff; }
        .elevator-call-panel { display: flex; flex-direction: column; gap: 15px; border: 2px solid #fff; padding: 15px; }
        .call-button { width: 50px; height: 50px; font-size: 1.5rem; border: 2px solid #fff; background: #000; color: #fff; cursor: pointer; }
        .call-button.home-active { background: #555; cursor: not-allowed; }
        .hallway-floor-display { border: 2px solid #fff; padding: 10px; margin-bottom: 15px; text-align: center; font-size: 1.5rem; }
        .view-upstairs-arrow {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-bottom: 20px solid #fff;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .travel-indicator { position: absolute; font-size: 10rem; opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none; }
        .travel-indicator.visible { opacity: 1; }

        .elevator-call-panel .call-button {
            position: relative;
        }

        .elevator-call-panel .call-button:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            border: 1px solid #555;
        }

        .elevator-call-panel .call-button:hover::before {
            content: '';
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #333;
            z-index: 1000;
        }

        /* Upstairs Viewer Styles */
        #upstairs-screen { position: relative; }
        .go-back-control { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .go-back-control .arrow { width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 20px solid #fff; }

        /* Store Screen Styles */
        #store-screen {
            flex-direction: column;
            justify-content: flex-start;
            padding-top: 100px;
        }
        .store-header {
            font-size: 2.5rem;
            margin-bottom: 40px;
        }
        .store-items {
            width: 90%;
            max-width: 800px;
            height: 60vh;
            overflow-y: auto;
            border: 2px solid #fff;
            padding: 20px;
        }
        .store-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #555;
        }
        .store-item:last-child {
            border-bottom: none;
        }
        .item-info h3 {
            margin: 0 0 5px 0;
            font-size: 1.5rem;
        }
        .item-info p {
            margin: 0;
            font-size: 1rem;
            color: #aaa;
        }
        .item-action {
            text-align: right;
        }
        .item-action .unlocks-text {
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #aaa;
        }
        .item-action .price-btn {
            border: 2px solid #fff;
            background: #fff;
            color: #000;
            padding: 10px 20px;
            font-family: 'Courier New', Courier, monospace;
            text-transform: uppercase;
            cursor: pointer;
        }
        .item-action .unlocked-label {
            border: 2px solid #0f0;
            color: #0f0;
            padding: 10px 20px;
        }
        .item-action .locked-label {
            border: 2px solid #555;
            color: #555;
            padding: 10px 20px;
        }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); justify-content: flex-start; align-items: center; overflow-y: auto; }
        .modal-content { background-color: #000; padding: 30px; border: 2px solid #fff; width: 90%; max-width: 500px; text-align: center; margin-top: 5vh; margin-bottom: 5vh; }
        .modal-content h2 { font-size: 1.5rem; }
        #edit-textarea { width: 100%; height: 100px; background-color: #000; color: #fff; border: 1px solid #fff; padding: 10px; font-family: 'Courier New', Courier, monospace; font-size: 1.2rem; box-sizing: border-box; resize: none; text-transform: uppercase; margin-bottom: 5px; }
        
        #current-image-container { display: none; margin-bottom: 15px; margin-top: 25px; }
        #current-image-preview { width: 150px; height: 150px; border: 2px solid #fff; object-fit: cover; }
        #remove-image-btn { display: none; background-color: #500; color: #fff; border: 2px solid #fff; padding: 5px 10px; font-size: 0.8rem; cursor: pointer; margin-top: 10px; }

        #image-upload-label { display: block; padding: 10px; border: 2px solid #fff; cursor: pointer; margin-bottom: 10px; }
        #image-upload { display: none; }
        #image-preview-text { font-size: 0.9rem; color: #aaa; margin-bottom: 15px; height: 20px;}
        .image-options { display: none; justify-content: center; gap: 20px; margin-bottom: 20px; }
        #char-count { font-size: 0.9rem; color: #aaa; align-self: flex-end; margin-bottom: 25px; }
        .modal-actions { display: flex; justify-content: space-around; width: 100%; }
        .modal-actions button { font-family: 'Courier New', Courier, monospace; font-size: 1rem; padding: 10px 20px; margin: 15px 5px 0 5px; cursor: pointer; border: 2px solid #fff; background: #fff; color: #000; text-transform: uppercase; }
        #move-out-btn { background: #500; color: #fff;}

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .site-title { font-size: 1.8rem; }
            #lobby-screen { flex-direction: column; gap: 30px; padding-top: 120px; }
            #lobby-screen .news-board { width: 90%; height: 300px; }
            
            .elevator-main-panel { flex-direction: column; }
            .elevator-panel { grid-template-columns: repeat(5, 1fr); max-width: 100%; }
            .elevator-side-controls { flex-direction: row; height: auto; width: 100%; justify-content: space-around; }

            .unit { width: 300px; height: 300px; }
            .elevator-door { width: 100px; height: 300px; }
            .elevator-door::before, .elevator-door::after { height: 300px; }
        }

        .store-item.selected {
            background-color: #333;
            border: 2px solid #fff;
        }

        .store-purchase-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 20px;
            align-items: center;
        }

        .total-price {
            font-size: 1.5rem;
            padding: 10px 20px;
            border: 2px solid #fff;
            background: #000;
        }

        .purchase-all-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            border: 2px solid #fff;
            background: #fff;
            color: #000;
            cursor: pointer;
            font-family: "Poor Story", system-ui;
            text-transform: uppercase;
        }

        .side-button, .call-button {
            position: relative;
        }

        .side-button:hover::after, .call-button:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
        }

        .side-button:hover::before, .call-button:hover::before {
            content: '';
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #333;
            z-index: 1000;
        }

        .user-info-display {
            border: 2px solid #0f0;
            background: #000;
            padding: 10px 20px;
            text-align: center;
            font-size: 1rem;
            margin: 5px 0;
            min-width: 160px;
            box-sizing: border-box;
        }

        .user-unit {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .user-days {
            font-size: 0.9rem;
            color: #aaa;
        }

    </style>
</head>
<body>

    <!-- All screens... -->
    <div id="lobby-screen" class="screen active">
        <h1 class="site-title">227 Parking Ave</h1>
        <div class="lobby-buttons">
            <button class="lobby-btn" id="sign-in-btn">Sign In with Google</button>
            <!-- Move user info above sign-out button -->
            <div class="user-info-display" id="user-info-display" style="display: none;">
                <div class="user-unit">Unit #<span id="user-unit-number">000</span></div>
                <div class="user-days">Day <span id="user-days-count">0</span></div>
            </div>
            <button class="lobby-btn" id="sign-out-btn" style="display:none;">Sign Out</button>
            <button class="lobby-btn" id="store-btn">Store</button>
        </div>
        <div class="elevator-section">
             <div class="elevator-door"></div>
            <div class="elevator-call-panel">
                <button class="call-button" id="lobby-call-elevator-btn" data-tooltip="Call Elevator">▲</button>
                <button class="call-button" id="lobby-call-home-btn" data-tooltip="Go to Your Unit">H</button>
                <div class="home-unit-display" id="home-unit-display" style="display: none;">
                    <div style="font-size: 0.8rem; text-align: center; margin-top: 10px; color: #aaa;">YOUR UNIT</div>
                    <div style="font-size: 1.2rem; text-align: center;">#000</div>
                </div>
            </div>
        </div>
        <div class="news-board">
            <h1>Community News</h1>
            <div class="news-content">
                <h2>Welcome to 227 Parking Ave!</h2>

                <p class="lobby-footer">Total Residents: <span id="total-residents">0</span></p>
                <p>A minimalist, social apartment. Find your unit, settle in, and get to know your neighbors.</p>
                <ul>
                    <li>Rules of the Complex:</li>
                    <li>1. Be kind, be respectful.</li>
                    <li>2. No heavy NSFW content.</li>
                    <li>3. Quiet hours are from 11 PM to 7 AM.</li>
                    <li>4. Upgrades Available Soon... ** Stay tuned!</li>
                </ul>
                <p>New Floors Added: We're expanding! The complex now reaches the <span id="max-floor-display">5th</span> floor. Welcome, new tenants!</p>
                <p><strong>Update:</strong> The management kindly reminds tenants to keep the hallways clear of digital debris. Thank you for your cooperation.</p>
                <p><strong>Notice:</strong> Scheduled maintenance on the main servers will occur this Sunday at 3 AM. Expect brief interruptions.</p>
                <p><strong>Community Event:</strong> Join us for a virtual meet-and-greet on the roof deck (feature coming soon) next Friday!</p>
            </div>
        </div>
    </div>
    <div id="elevator-screen" class="screen">
         <h1 id="elevator-header">ELEVATOR</h1>
         <div class="elevator-top-indicator" id="elevator-floor-display">3</div>
         <div class="elevator-main-panel">
            <div class="elevator-panel" id="elevator-panel"></div>
            <div class="elevator-side-controls">
                <button class="side-button" id="random-floor-btn">R</button>
                <button class="side-button" id="floor-page-up" disabled>▲</button>
                <button class="side-button" id="home-floor-btn-elevator">H</button>
                <button class="side-button" id="floor-page-down" disabled>▼</button>
            </div>
        </div>
    </div>
    <div id="floor-screen" class="screen">
        <div class="travel-indicator" id="travel-indicator"></div>
        <div class="floor-hallway" id="floor-hallway"></div>
    </div>
    <div id="upstairs-screen" class="screen">
         <div id="upstairs-unit-container"></div>
         <div class="go-back-control" id="go-back-home-btn">
             <span>CLICK DOWN TO GO BACK</span>
             <div class="arrow"></div>
         </div>
    </div>

    <!-- Store Screen -->
    <div id="store-screen" class="screen">
        <h1 class="store-header">UPGRADE STORE</h1>
        <div class="store-items" id="store-items-container">
            <!-- Store items will be generated here -->
        </div>

        <div class="store-purchase-controls" id="store-purchase-controls">
            <div class="total-price" id="total-price">Total: $0.00</div>
            <button class="purchase-all-btn" id="purchase-all-btn">Purchase Selected</button>
            <button class="lobby-btn" id="clear-selection-btn">Clear Selection</button>
        </div>
        <button class="lobby-btn" id="back-to-lobby-btn" style="margin-top: 30px;">Back to Lobby</button>
    </div>

    <!-- Unit Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h2 id="edit-modal-title">Edit Your Unit</h2>
            <textarea id="edit-textarea"></textarea>
            <p id="char-count">Characters: 0 / 50</p>
            
            <div id="current-image-container">
                <p style="font-size: 0.9rem; color: #aaa;">Current Image:</p>
                <img id="current-image-preview" src="" alt="Current Unit Image">
                <button id="remove-image-btn">Remove Image</button>
            </div>

            <label for="image-upload" id="image-upload-label">Upload Image</label>
            <input type="file" id="image-upload" accept="image/*">
            <div id="image-preview-text">No file selected</div>

            <div class="image-options" id="image-options">
                <label><input type="radio" name="image-mode" value="bw" checked> B&W</label>
                <label><input type="radio" name="image-mode" value="color"> Color</label>
            </div>

            <div class="modal-actions">
                <button id="move-out-btn">Move Out</button>
                <div>
                    <button id="save-changes-btn">Save</button>
                    <button id="cancel-edit-btn">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Simulated User and Tenant Data ---
        let MY_UNIT_ID = null; //308;
        const MAX_FLOORS = 5;
        let MY_HOME_FLOOR = null; // Math.floor(MY_UNIT_ID / 100);

        const daysAgo = (days) => {
            const date = new Date();
            date.setDate(date.getDate() - days);
            return date.toISOString();
        };

        // This would eventually come from a database
        let tenants = [
            { userId: 'user1', unitId: 308, moveInDate: daysAgo(64), content: "BEEN HERE A COUPLE OF MONTHS. IT'S QUIET. I LIKE IT.", imageUrl: null, purchasedUpgrades: [] },
            { userId: 'user2', unitId: 201, moveInDate: daysAgo(120), content: "ORIGINAL TENANT.", imageUrl: null, purchasedUpgrades: ['outline-green'] },
            { userId: 'user3', unitId: 202, moveInDate: daysAgo(5), content: "JUST MOVED IN!", imageUrl: null, purchasedUpgrades: [] },
            { userId: 'user4', unitId: 204, moveInDate: daysAgo(18), content: "my god", imageUrl: null, purchasedUpgrades: [] },
            { userId: 'user5', unitId: 205, moveInDate: daysAgo(80), content: "what do I need", imageUrl: null, purchasedUpgrades: [] },
            { userId: 'user6', unitId: 206, moveInDate: daysAgo(201), content: "we are finally here", imageUrl: null, purchasedUpgrades: [] },
            { userId: 'user7', unitId: 207, moveInDate: daysAgo(864), content: "everyone welcome!", imageUrl: null, purchasedUpgrades: [] },
            { userId: 'user8', unitId: 208, moveInDate: daysAgo(900), content: "Make your self at home", imageUrl: null, purchasedUpgrades: [] },
        ];

        const upgrades = [
            { id: 'outline-green', name: 'Green Unit Outline', description: 'Change your unit outline to green.', daysToUnlock: 7, price: 0.99 },
            { id: 'emoji-pack-1', name: 'Basic Emojis', description: 'Unlock basic emoji support.', daysToUnlock: 14, price: 0.99 },
            { id: 'char-100', name: 'Expanded Vocabulary', description: 'Increase character limit to 100.', daysToUnlock: 63, price: 0.99 }, // Unlocks after 9 weeks
            { id: 'char-200', name: 'Freedom of Speech', description: 'Increase character limit to 200.', daysToUnlock: 126, price: 0.99 }, // Unlocks after 18 weeks
            { id: 'image-bw', name: 'B&W Photos', description: 'Upload pixelated B&W photos.', daysToUnlock: 133, price: 0.99, requires: 'char-200' }, // Unlocks 1 week after char-200
            { id: 'image-color', name: 'Color Photos', description: 'Upload pixelated color photos.', daysToUnlock: 180, price: 0.99, requires: 'image-bw' }
        ];


        // --- State Management & DOM Elements ---
        let currentView = 'lobby';
        let currentFloor = 1;
        let editingUnitId = null;
        let selectedFile = null;
        let removeImage = false;
        let signedInUser = null; // This will hold the signed-in tenant object

        const screens = document.querySelectorAll('.screen');
        const lobbyCallElevatorBtn = document.getElementById('lobby-call-elevator-btn');
        const lobbyCallHomeBtn = document.getElementById('lobby-call-home-btn');
        const elevatorFloorDisplay = document.getElementById('elevator-floor-display');
        const elevatorPanel = document.getElementById('elevator-panel');
        const randomFloorBtn = document.getElementById('random-floor-btn');
        const homeFloorBtnElevator = document.getElementById('home-floor-btn-elevator');
        const floorHallway = document.getElementById('floor-hallway');
        const travelIndicator = document.getElementById('travel-indicator');
        const upstairsScreenContainer = document.getElementById('upstairs-unit-container');
        const goBackHomeBtn = document.getElementById('go-back-home-btn');
        const editModal = document.getElementById('edit-modal');
        const editModalTitle = document.getElementById('edit-modal-title');
        const editTextArea = document.getElementById('edit-textarea');
        const charCount = document.getElementById('char-count');
        const imageUploadInput = document.getElementById('image-upload');
        const imageUploadLabel = document.getElementById('image-upload-label');
        const imagePreviewText = document.getElementById('image-preview-text');
        const imageOptions = document.getElementById('image-options');
        const currentImageContainer = document.getElementById('current-image-container');
        const currentImagePreview = document.getElementById('current-image-preview');
        const removeImageBtn = document.getElementById('remove-image-btn');
        const moveOutBtn = document.getElementById('move-out-btn');
        const saveChangesBtn = document.getElementById('save-changes-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const signInBtn = document.getElementById('sign-in-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const storeBtn = document.getElementById('store-btn');
        const storeItemsContainer = document.getElementById('store-items-container');
        const backToLobbyBtn = document.getElementById('back-to-lobby-btn');

        
        // --- Core Logic & Functions ---
        function switchView(viewName) {
            currentView = viewName;
            screens.forEach(screen => {
                screen.classList.toggle('active', screen.id === `${viewName}-screen`);
            });
            
            // ADD THIS: Refresh lobby data when returning to lobby
            if (viewName === 'lobby') {
                renderLobby();
            }
        }
        function getDaysStayed(moveInDate) {
            const startDate = new Date(moveInDate);
            const today = new Date();
            const diffTime = Math.abs(today - startDate);
            const days = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return Math.max(1, days);
        }
        function getCharLimit(tenant) {
            if (!tenant) return 0;
            const days = getDaysStayed(tenant.moveInDate);
            const naturalLimit = Math.min(50, 10 + Math.floor(Math.max(0, days - 1) / 7) * 5);
            
            if (tenant.purchasedUpgrades.includes('char-200')) return 200;
            if (tenant.purchasedUpgrades.includes('char-100')) return 100;
            
            return naturalLimit;
        }

        function pixelateImage(file, pixelationFactor = 64, mode = 'color') {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const size = Math.min(img.width, img.height);
                        const sx = (img.width - size) / 2;
                        const sy = (img.height - size) / 2;
                        const smallCanvas = document.createElement('canvas');
                        smallCanvas.width = pixelationFactor;
                        smallCanvas.height = pixelationFactor;
                        const smallCtx = smallCanvas.getContext('2d');
                        smallCtx.drawImage(img, sx, sy, size, size, 0, 0, pixelationFactor, pixelationFactor);
                        const outputSize = 200;
                        canvas.width = outputSize;
                        canvas.height = outputSize;
                        ctx.imageSmoothingEnabled = false;
                        ctx.drawImage(smallCanvas, 0, 0, pixelationFactor, pixelationFactor, 0, 0, outputSize, outputSize);
                        if (mode === 'bw') {
                            const imageData = ctx.getImageData(0, 0, outputSize, outputSize);
                            const data = imageData.data;
                            for (let i = 0; i < data.length; i += 4) {
                                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                                data[i] = avg; data[i + 1] = avg; data[i + 2] = avg;
                            }
                            ctx.putImageData(imageData, 0, 0);
                        }
                        resolve(canvas.toDataURL());
                    };
                    img.onerror = reject;
                    img.src = event.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function getOrdinalNumber(n) {
            const suffixes = ["th", "st", "nd", "rd"];
            const v = n % 100;
            return n + (suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0]);
        }

        function renderLobby() { 
            document.getElementById('total-residents').textContent = tenants.length;
            document.getElementById('max-floor-display').textContent = getOrdinalNumber(MAX_FLOORS);
            
            // Show/hide user info based on sign-in status
            const userInfoDisplay = document.getElementById('user-info-display');
            if (signedInUser && userInfoDisplay) {
                userInfoDisplay.style.display = 'block';
                document.getElementById('user-unit-number').textContent = MY_UNIT_ID;
                document.getElementById('user-days-count').textContent = getDaysStayed(signedInUser.moveInDate);
            } else if (userInfoDisplay) {
                userInfoDisplay.style.display = 'none';
            }
        }

        // --- View Rendering & Animation ---
        function renderElevator() {
            document.getElementById('random-floor-btn').setAttribute('data-tooltip', 'Random Floor');
            document.getElementById('home-floor-btn-elevator').setAttribute('data-tooltip', 'Go Home');
            elevatorFloorDisplay.textContent = (currentFloor === 1) ? 'L' : currentFloor;
            elevatorPanel.innerHTML = '';
            for (let i = 1; i <= 20; i++) {
                const button = document.createElement('button');
                button.className = 'floor-button';
                button.textContent = (i === 1) ? 'L' : i;
                if (i === currentFloor) button.classList.add('active');
                if (i > MAX_FLOORS && i !== 1) button.disabled = true;
                button.dataset.floor = i;
                elevatorPanel.appendChild(button);
            }
            homeFloorBtnElevator.disabled = !signedInUser;
            homeFloorBtnElevator.classList.toggle('home-disabled', !signedInUser || currentFloor === MY_HOME_FLOOR);
        }

        function createUnitHTML(unitId, isUpstairsView = false) {
            const tenant = tenants.find(t => t.unitId === unitId);
            let homeLabel = (signedInUser && unitId === MY_UNIT_ID) ? ' / HOME' : '';

            if (!tenant) return `<div class="unit vacant">VACANT</div>`;

            let upstairsArrowHTML = '';
            if (signedInUser && unitId === MY_UNIT_ID && !isUpstairsView) {
                const upstairsTenant = tenants.find(t => t.unitId === MY_UNIT_ID + 100);
                if (upstairsTenant) {
                    upstairsArrowHTML = `<div class="view-upstairs-arrow" data-upstairs-unitid="${MY_UNIT_ID + 100}"></div>`;
                }
            }
            
            let imageHTML = '';
            if (tenant.imageUrl) {
                imageHTML = `<div class="unit-image-container"><img src="${tenant.imageUrl}" alt="Unit Image"></div>`;
            }

            let outlineClass = '';
            if (tenant.purchasedUpgrades.includes('outline-green')) {
                outlineClass = 'green-outline';
            }


            return `
                <div class="unit ${homeLabel ? 'my-unit' : ''} ${outlineClass}">
                    ${upstairsArrowHTML}
                    <div class="unit-header">
                        <span>UNIT # ${unitId}${homeLabel}</span>
                        <span>DAY ${getDaysStayed(tenant.moveInDate)}</span>
                    </div>
                    <div class="unit-content">
                        ${imageHTML}
                        <div class="unit-text">${tenant.content}</div>
                    </div>
                    ${homeLabel ? `<button class="edit-button" data-unitid="${unitId}">EDIT</button>` : ''}
                </div>`;
        }

        function renderFloorView() {
            floorHallway.innerHTML = '';
            for (let i = 1; i <= 5; i++) { floorHallway.innerHTML += createUnitHTML(currentFloor * 100 + i); }
            floorHallway.innerHTML += `
                <div class="elevator-section" id="elevator-section">
                    <div class="hallway-floor-display">${currentFloor}</div>
                    <div class="elevator-door"></div>
                    <div class="elevator-call-panel">
                        <button class="call-button" id="call-up" data-tooltip="Go Up">▲</button>
                        <button class="call-button ${signedInUser && currentFloor === MY_HOME_FLOOR ? 'home-active' : ''}" id="call-home" data-tooltip="Go Home">H</button>
                        <button class="call-button" id="call-down" data-tooltip="Go Down">▼</button>
                    </div>
                </div>`;
            for (let i = 6; i <= 10; i++) { floorHallway.innerHTML += createUnitHTML(currentFloor * 100 + i); }
            setTimeout(() => {
                const elevator = document.getElementById('elevator-section');
                if (elevator) {
                    const screenCenter = window.innerWidth / 2;
                    const elevatorCenter = elevator.offsetLeft + elevator.offsetWidth / 2;
                    floorHallway.style.left = `${screenCenter - elevatorCenter}px`;
                }
                
                const allUnitContents = floorHallway.querySelectorAll('.unit-content');
                allUnitContents.forEach(content => {
                    if (content.scrollHeight > content.clientHeight) {
                        content.style.justifyContent = 'flex-start';
                    } else {
                        content.style.justifyContent = 'center';
                    }
                });
            }, 0);
        }

        function handleGoogleSignIn(response) {
            // Decode the JWT token to get user info
            const userInfo = JSON.parse(atob(response.credential.split('.')[1]));
            
            // Check if user already exists
            let existingUser = tenants.find(t => t.userId === userInfo.sub);
            
            if (existingUser) {
                // Existing user
                signedInUser = existingUser;
                MY_UNIT_ID = signedInUser.unitId;
                MY_HOME_FLOOR = Math.floor(MY_UNIT_ID / 100);
                currentFloor = MY_HOME_FLOOR;
            } else {
                // New user - find vacant unit
                const vacantUnit = findVacantUnit();
                if (vacantUnit) {
                    const newTenant = {
                        userId: userInfo.sub,
                        name: userInfo.name,
                        email: userInfo.email,
                        picture: userInfo.picture,
                        unitId: vacantUnit,
                        moveInDate: new Date().toISOString(),
                        content: "JUST MOVED IN!",
                        imageUrl: null,
                        purchasedUpgrades: []
                    };
                    tenants.push(newTenant);
                    signedInUser = newTenant;
                    MY_UNIT_ID = signedInUser.unitId;
                    MY_HOME_FLOOR = Math.floor(MY_UNIT_ID / 100);
                    currentFloor = MY_HOME_FLOOR;
                } else {
                    alert("Sorry, no vacant units available!");
                    return;
                }
            }
            
            signInBtn.style.display = 'none';
            signOutBtn.style.display = 'block';
            lobbyCallHomeBtn.disabled = false;
            renderLobby();
        }

        function initializeGoogleSignIn() {
            if (typeof google !== 'undefined' && google.accounts) {
                google.accounts.id.initialize({
                    client_id: 'YOUR_ACTUAL_CLIENT_ID_HERE', // Replace with your real client ID
                    callback: handleGoogleSignIn,
                    auto_select: false, // This ensures account picker shows
                    cancel_on_tap_outside: false
                });
            }
        }

        function findVacantUnit() {
            for (let floor = 2; floor <= MAX_FLOORS; floor++) {
                for (let unit = 1; unit <= 10; unit++) {
                    const unitId = floor * 100 + unit;
                    if (!tenants.find(t => t.unitId === unitId)) {
                        return unitId;
                    }
                }
            }
            return null;
        }

        function renderStore() {
            storeItemsContainer.innerHTML = '';
            if (!signedInUser) return;
            const days = getDaysStayed(signedInUser.moveInDate);

            upgrades.forEach(upgrade => {
                const isPurchased = signedInUser.purchasedUpgrades.includes(upgrade.id);
                const isUnlockedByTime = days >= upgrade.daysToUnlock;
                let isPrereqMet = true;
                if (upgrade.requires) {
                    isPrereqMet = signedInUser.purchasedUpgrades.includes(upgrade.requires);
                }
                
                let actionHTML = '';
                if (isPurchased) {
                    actionHTML = `<div class="unlocked-label">PURCHASED</div>`;
                } else if (isUnlockedByTime && isPrereqMet) {
                    actionHTML = `<button class="price-btn" data-upgradeid="${upgrade.id}">$${upgrade.price.toFixed(2)}</button>`;
                } else if (!isPrereqMet) {
                    const prereqUpgrade = upgrades.find(u => u.id === upgrade.requires);
                    actionHTML = `<div class="locked-label">REQUIRES: ${prereqUpgrade.name}</div>`;
                } else {
                    const daysLeft = upgrade.daysToUnlock - days;
                    actionHTML = `
                        <div class="unlocks-text">${daysLeft} days left to unlock</div>
                        <button class="price-btn" data-upgradeid="${upgrade.id}">$${upgrade.price.toFixed(2)}</button>
                    `;
                }

                storeItemsContainer.innerHTML += `
                    <div class="store-item">
                        <div class="item-info">
                            <h3>${upgrade.name}</h3>
                            <p>${upgrade.description}</p>
                        </div>
                        <div class="item-action">
                            ${actionHTML}
                        </div>
                    </div>
                `;
            });
        }

        function renderUpstairsView() {
             const upstairsUnitId = MY_UNIT_ID + 100;
             upstairsScreenContainer.innerHTML = createUnitHTML(upstairsUnitId, true);
        }
        function animateFloorTravel(fromFloor, toFloor) {
            switchView('floor');
            floorHallway.style.opacity = '0';
            travelIndicator.textContent = fromFloor === 1 ? 'L' : fromFloor;
            travelIndicator.classList.add('visible');
            let floor = fromFloor;
            const direction = fromFloor < toFloor ? 1 : -1;
            const interval = setInterval(() => {
                floor += direction;
                travelIndicator.textContent = floor;
                if (floor === toFloor) {
                    clearInterval(interval);
                    setTimeout(() => {
                        travelIndicator.classList.remove('visible');
                        renderFloorView();
                        floorHallway.style.opacity = '1';
                    }, 300);
                }
            }, 150);
        }

        function simulateSignIn() {
            const demoUser = tenants.find(t => t.userId === 'user1');
            if (demoUser) {
                signedInUser = demoUser;
                MY_UNIT_ID = signedInUser.unitId;
                MY_HOME_FLOOR = Math.floor(MY_UNIT_ID / 100);
                currentFloor = MY_HOME_FLOOR;
                signInBtn.style.display = 'none';
                signOutBtn.style.display = 'block';
                lobbyCallHomeBtn.disabled = false;
                renderLobby();
                alert('Demo sign-in successful! (Using demo account)');
            }
        }


        function updatePurchaseControls() {
            const controls = document.getElementById('store-purchase-controls');
            const totalPrice = document.getElementById('total-price');
            const purchaseBtn = document.getElementById('purchase-all-btn');
            
            if (selectedUpgrades.length === 0) {
                controls.style.display = 'none';
                return;
            }
            
            controls.style.display = 'flex';
            const total = selectedUpgrades.reduce((sum, upgradeId) => {
                const upgrade = upgrades.find(u => u.id === upgradeId);
                return sum + upgrade.price;
            }, 0);
            
            totalPrice.textContent = `Total: $${total.toFixed(2)}`;
            purchaseBtn.textContent = selectedUpgrades.length === 1 ? 'Purchase Item' : `Purchase ${selectedUpgrades.length} Items`;
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            signInBtn.addEventListener('click', () => {
                if (typeof google !== 'undefined' && google.accounts) {
                    google.accounts.id.initialize({
                        client_id: '648031542086-ev3jvpjanmukht7ad6uutkmr5uceltlj.apps.googleusercontent.com',
                        callback: handleGoogleSignIn
                    });
                    
                    // This will show the account picker popup
                    google.accounts.id.prompt();
                } else {
                    // Fallback for demo/testing
                    simulateSignIn();
                }
            });


            signOutBtn.addEventListener('click', () => {
                signedInUser = null;
                MY_UNIT_ID = null;
                MY_HOME_FLOOR = null;
                signInBtn.style.display = 'block';
                signOutBtn.style.display = 'none';
                lobbyCallHomeBtn.disabled = true;
                renderLobby(); // This will hide the user info
            });

            storeBtn.addEventListener('click', () => {
                if(signedInUser) {
                    renderStore();
                    switchView('store');
                } else {
                    alert("Please sign in to access the store.");
                }
            });

            backToLobbyBtn.addEventListener('click', () => switchView('lobby'));

            let selectedUpgrades = [];

            storeItemsContainer.addEventListener('click', (e) => {
                if (e.target.matches('.price-btn')) {
                    const upgradeId = e.target.dataset.upgradeid;
                    const storeItem = e.target.closest('.store-item');
                    
                    if (selectedUpgrades.includes(upgradeId)) {
                        // Deselect
                        selectedUpgrades = selectedUpgrades.filter(id => id !== upgradeId);
                        storeItem.classList.remove('selected');
                    } else {
                        // Select
                        selectedUpgrades.push(upgradeId);
                        storeItem.classList.add('selected');
                    }
                    
                    updatePurchaseControls();
                }
            });

            lobbyCallElevatorBtn.addEventListener('click', () => { currentFloor = 1; renderElevator(); switchView('elevator'); });
            lobbyCallHomeBtn.addEventListener('click', () => {
                if (!signedInUser) return;
                const fromFloor = 1;
                if (MY_HOME_FLOOR !== fromFloor) {
                    currentFloor = MY_HOME_FLOOR;
                    animateFloorTravel(fromFloor, MY_HOME_FLOOR);
                } else {
                     renderFloorView();
                     switchView('floor');
                }
            });
            elevatorPanel.addEventListener('click', (e) => {
                if (e.target.matches('.floor-button:not(:disabled)')) {
                    const fromFloor = currentFloor;
                    const targetFloor = parseInt(e.target.dataset.floor);
                    if (targetFloor === 1) { switchView('lobby'); return; }
                    currentFloor = targetFloor;
                    if (targetFloor !== fromFloor) { animateFloorTravel(fromFloor, targetFloor); } 
                    else { renderFloorView(); switchView('floor'); }
                }
            });
            randomFloorBtn.addEventListener('click', () => {
                const fromFloor = currentFloor;
                const possibleFloors = Array.from({length: MAX_FLOORS - 1}, (_, i) => i + 2);
                const validFloors = possibleFloors.filter(floor => floor !== currentFloor);
                if (validFloors.length > 0) {
                    const randomFloor = validFloors[Math.floor(Math.random() * validFloors.length)];
                    currentFloor = randomFloor;
                    animateFloorTravel(fromFloor, randomFloor);
                }
            });
            homeFloorBtnElevator.addEventListener('click', () => {
                 if (!signedInUser) return;
                 const fromFloor = currentFloor;
                 if (MY_HOME_FLOOR !== fromFloor) {
                    currentFloor = MY_HOME_FLOOR;
                    animateFloorTravel(fromFloor, MY_HOME_FLOOR);
                }
            });
            document.getElementById('floor-screen').addEventListener('wheel', (e) => {
                const unitContent = e.target.closest('.unit-content');
                if (unitContent && unitContent.scrollHeight > unitContent.clientHeight) {
                    return;
                }
                e.preventDefault();
                const hallway = floorHallway;
                const currentLeft = parseFloat(hallway.style.left) || 0;
                let newLeft = currentLeft - e.deltaY * 2.5;
                const screenWidth = window.innerWidth;
                const hallwayWidth = hallway.scrollWidth;
                const maxLeft = 50; 
                const minLeft = screenWidth - hallwayWidth - 50;
                if (newLeft > maxLeft) newLeft = maxLeft;
                if (newLeft < minLeft) newLeft = minLeft;
                hallway.style.left = `${newLeft}px`;
            });
            floorHallway.addEventListener('click', (e) => {
                const callButton = e.target.closest('.call-button');
                if (callButton) {
                     if (callButton.id === 'call-up' || callButton.id === 'call-down' || (callButton.id === 'call-home' && !callButton.classList.contains('home-active'))) {
                        renderElevator();
                        switchView('elevator');
                    }
                }
                const editButton = e.target.closest('.edit-button');
                if (editButton) {
                    editingUnitId = parseInt(editButton.dataset.unitid);
                    const tenant = tenants.find(t => t.unitId === editingUnitId);
                    if (tenant) {
                        const charLimit = getCharLimit(tenant);
                        const hasImageAccess = tenant.purchasedUpgrades.includes('image-bw') || tenant.purchasedUpgrades.includes('image-color');
                        
                        editModalTitle.textContent = `EDIT UNIT #${editingUnitId}`;
                        editTextArea.value = tenant.content;
                        editTextArea.maxLength = charLimit;
                        charCount.textContent = `${tenant.content.length} / ${charLimit}`;
                        
                        // Hide/show image upload based on access
                        const imageUploadSection = document.getElementById('image-upload-label');
                        const imagePreview = document.getElementById('image-preview-text');
                        const imageOptions = document.getElementById('image-options');
                        
                        if (hasImageAccess) {
                            imageUploadSection.style.display = 'block';
                            imagePreview.style.display = 'block';
                            // ... rest of image logic
                        } else {
                            imageUploadSection.style.display = 'none';
                            imagePreview.style.display = 'none';
                            imageOptions.style.display = 'none';
                        }
                        
                        // ... rest of existing logic
                        editModal.style.display = 'flex';
                    }
                }
                const upstairsArrow = e.target.closest('.view-upstairs-arrow');
                if (upstairsArrow) {
                    renderUpstairsView();
                    switchView('upstairs');
                }
            });
            goBackHomeBtn.addEventListener('click', () => { switchView('floor'); });
            
            editTextArea.addEventListener('input', () => {
                if (!signedInUser) return;
                const charLimit = getCharLimit(signedInUser);
                charCount.textContent = `${editTextArea.value.length} / ${charLimit}`;
            });

            imageUploadInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    selectedFile = e.target.files[0];
                    imagePreviewText.textContent = selectedFile.name;
                    imageOptions.style.display = 'flex';
                    currentImageContainer.style.display = 'none';
                    removeImageBtn.style.display = 'none';
                }
            });
            removeImageBtn.addEventListener('click', () => {
                removeImage = true;
                currentImageContainer.style.display = 'none';
                removeImageBtn.style.display = 'none';
                imageUploadLabel.textContent = 'Upload Image';
            });
            moveOutBtn.addEventListener('click', () => {
                if (signedInUser) {
                    const index = tenants.findIndex(t => t.userId === signedInUser.userId);
                    if (index > -1) {
                        tenants.splice(index, 1);
                        signOutBtn.click(); // Simulate signing out
                        renderLobby();
                        editModal.style.display = 'none';
                        alert('You have moved out. Your unit is now vacant.');
                    }
                }
            });
            saveChangesBtn.addEventListener('click', async () => {
                if (editingUnitId === null) return;
                const tenant = tenants.find(t => t.unitId === editingUnitId);
                if (!tenant) return;
                tenant.content = editTextArea.value.toUpperCase();
                
                if (removeImage) {
                    tenant.imageUrl = null;
                } else if (selectedFile) {
                    try {
                        const imageMode = document.querySelector('input[name="image-mode"]:checked').value;
                        const processedImageUrl = await pixelateImage(selectedFile, 64, imageMode);
                        tenant.imageUrl = processedImageUrl;
                    } catch (error) {
                        console.error("Image processing failed:", error);
                        imagePreviewText.textContent = "Error processing image.";
                    }
                }
                renderFloorView();
                editModal.style.display = 'none';
                editingUnitId = null;
                selectedFile = null;
                removeImage = false;
            });
            cancelEditBtn.addEventListener('click', () => { 
                editModal.style.display = 'none'; 
                editingUnitId = null;
                selectedFile = null;
                removeImage = false;
            });

            document.getElementById('purchase-all-btn').addEventListener('click', () => {
                if (signedInUser && selectedUpgrades.length > 0) {
                    selectedUpgrades.forEach(upgradeId => {
                        if (!signedInUser.purchasedUpgrades.includes(upgradeId)) {
                            signedInUser.purchasedUpgrades.push(upgradeId);
                        }
                    });
                    selectedUpgrades = [];
                    renderStore();
                    document.getElementById('store-purchase-controls').style.display = 'none';
                }
            });

            document.getElementById('clear-selection-btn').addEventListener('click', () => {
                selectedUpgrades = [];
                document.querySelectorAll('.store-item').forEach(item => item.classList.remove('selected'));
                document.getElementById('store-purchase-controls').style.display = 'none';
            });

        }
        // --- Initial Load ---
        function init() {
            renderLobby();
            setupEventListeners();
            switchView('lobby');
        }
        init();
    </script>
</body>
</html>

